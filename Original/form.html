<!DOCTYPE html>
<html lang="zh-Hant-TW" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ç¢§æŸ³è¨˜å¸³å†Š v10</title>
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0f0f12"  media="(prefers-color-scheme: dark)">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* ===== iOS äº®è‰²ï¼ˆå«ç»ç’ƒï¼‰ ===== */
    :root{
      --bg: #ffffff;
      --fg: #0b0b0f;
      --muted: #6b7280;
      --line: rgba(60,60,67,0.18);
      --tint: #0a84ff;
      --tint-pressed: #0066cc;

      --card: rgba(255,255,255,0.68);
      --card-blur: blur(18px) saturate(160%);
      --shadow: 0 18px 40px rgba(0,0,0,.06), 0 1px 0 rgba(0,0,0,.04) inset;

      --field-bg: rgba(255,255,255,0.98);
      --field-border: rgba(60,60,67,0.18);
      --tag-bg: rgba(255,255,255,0.98);

      --ink-income-bg: rgba(10,132,255,.10);
      --ink-income-border: rgba(10,132,255,.28);
      --ink-expense-bg: rgba(255,59,48,.08);
      --ink-expense-border: rgba(255,59,48,.24);
      --ink-balance-bg: rgba(52,199,89,.10);
      --ink-balance-border: rgba(52,199,89,.28);

      /* å·¦å´ sort æŠ½å±œå¯¬åº¦ */
      --flt-w: 140px;
    }
    @media (max-width: 900px){ :root{ --flt-w: 130px; } }

    /* ===== æš—è‰² ===== */
    html[data-theme="dark"]{
      color-scheme: dark;
      --bg: #0f0f12; --fg: #f5f5f7; --muted: #a1a1aa; --line: rgba(255,255,255,0.14);
      --card: rgba(26,26,28,0.68); --card-blur: blur(18px) saturate(140%); --shadow: 0 20px 44px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.04) inset;
      --field-bg: rgba(36,36,38,0.9); --field-border: rgba(255,255,255,0.08); --tag-bg: rgba(40,40,42,0.9);
      --ink-income-bg: rgba(10,132,255,.22); --ink-income-border: rgba(10,132,255,.55);
      --ink-expense-bg: rgba(255,69,58,.22); --ink-expense-border: rgba(255,69,58,.55);
      --ink-balance-bg: rgba(48,209,88,.22); --ink-balance-border: rgba(48,209,88,.55);
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, "Noto Sans", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color: var(--fg);
      background:
        radial-gradient(1200px 800px at 0% -10%, rgba(10,132,255,.06), transparent 60%),
        radial-gradient(1000px 700px at 100% 110%, rgba(52,199,89,.06), transparent 60%),
        linear-gradient(to bottom, var(--bg), var(--bg));
    }

    .app { display:flex; min-height: 100dvh; }

    /* ===== å³å´æŠ½å±œï¼ˆä¸»é¸å–®ï¼‰ ===== */
    .sidebar{
      position: fixed; top:0; right:0; bottom:0; width: 280px;
      background: var(--card);
      -webkit-backdrop-filter: var(--card-blur); backdrop-filter: var(--card-blur);
      border-left: 1px solid var(--line);
      box-shadow: var(--shadow);
      transform: translateX(100%); transition: transform .25s ease;
      z-index: 30; padding: 18px 14px;
    }
    .sidebar.open{ transform: translateX(0); }
    .sb-head{ display:flex; align-items:center; justify-content:space-between; margin: 2px 6px 12px; }
    .sb-title{ font-weight:800; letter-spacing:-.01em; font-size: 26px; }
    .sb-close{
      border:1px solid var(--line); background: var(--field-bg); color: var(--fg);
      border-radius: 999px; padding: 6px 10px; font-size: 13px; cursor:pointer;
    }
    .sb-group{ margin: 8px 0; }
    .sb-link{
      display:flex; align-items:center; gap:10px;
      padding: 12px 14px; margin: 6px 0; border-radius: 14px;
      text-decoration:none; color: var(--fg); border:1px solid transparent;
      background: var(--field-bg); cursor:pointer; font-size: 16px; font-weight:700;
    }
    .sb-link:hover{ filter: brightness(0.98); }
    .sb-link.active{ outline: 2px solid var(--tint); }
    .sb-foot{ margin-top: 16px; font-size: 12px; color: var(--muted); }

    .content{ flex:1; min-width:0; width:100%; }

    .topbar{
      display:grid; grid-template-columns: 1fr auto; grid-template-areas:
        "left right"
        "center center";
      gap:6px;
      padding: 14px 16px; position: sticky; top:0; z-index: 10;
      background: color-mix(in oklab, var(--bg) 90%, white);
      border-bottom: 1px solid var(--line);
      -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
    }
    .topbar-row{ display:flex; align-items:center; justify-content:space-between; grid-area: left / left / left / right; }
    .large-title{ font-size: clamp(22px, 4vw, 30px); font-weight: 800; letter-spacing: -0.02em; margin: 0 6px; }
    .subtitle{ color: var(--muted); font-weight: 600; font-size: 14px; }
    .rightbar{ display:flex; gap:10px; align-items:center; }
    .menu-btn{
      border:1px solid var(--line); background: var(--field-bg); color: var(--fg);
      border-radius: 12px; padding: 8px 12px; font-size: 14px; cursor:pointer;
    }
    .theme-toggle{ display:flex; gap:6px; align-items:center; }
    .seg-sm{ display:flex; gap:6px; }
    .seg-sm button{
      border:1px solid var(--line); background: var(--field-bg); color: var(--fg);
      border-radius: 12px; padding: 6px 10px; font-size: 13px; cursor:pointer;
    }
    .seg-sm button.active{ background: var(--tint); color: #fff; border-color: transparent; box-shadow: 0 4px 10px rgba(10,132,255,.25); }

    .topbar-center{
      grid-area: center;
      display:flex; align-items:center; justify-content:center; gap:12px;
      font-weight: 800; letter-spacing:-.01em;
    }
    .page-name{ font-size: 16px; color: var(--muted); }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 16px; }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 22px;
      padding: clamp(14px, 3vw, 20px);
      box-shadow: var(--shadow);
      margin: 12px auto;
      -webkit-backdrop-filter: var(--card-blur); backdrop-filter: var(--card-blur);
    }

    .row { display:flex; gap: 12px; }
    .col { flex:1; min-width: 0; display: flex; flex-direction: column; }
    @media (max-width: 740px){ .row { flex-direction: column; } }

    label{ font-size: 13px; color: var(--muted); margin: 2px 2px 6px; font-weight: 600; }
    input[type="date"],
    input[type="text"],
    input[type="number"],
    select{
      appearance: none; background: var(--field-bg); color: var(--fg);
      border: 1px solid var(--field-border); border-radius: 16px;
      padding: 12px 14px; font-size: 16px; outline: none;
      transition: box-shadow .2s ease, border-color .2s ease;
      box-shadow: 0 1px 0 rgba(255,255,255,.35) inset, 0 1px 2px rgba(0,0,0,.06);
    }
    input:focus, select:focus{ border-color: rgba(10,132,255,.45); box-shadow: 0 0 0 4px rgba(10,132,255,.16); }

    .seg{ display:flex; border:1px solid var(--field-border); border-radius: 14px; padding: 3px; background: var(--field-bg); }
    .seg input{ display:none; }
    .seg label{ flex:1; text-align:center; padding:10px 8px; border-radius: 10px; font-weight: 700; cursor: pointer; }
    .seg input:checked + label{ background: var(--tint); color: white; box-shadow: 0 6px 14px rgba(10,132,255,.25); }

    .btn{
      border: none; border-radius: 16px; padding: 12px 18px; font-size: 16px; font-weight: 700;
      background: var(--tint); color: white; box-shadow: 0 8px 18px rgba(10,132,255,.25), 0 1px 0 rgba(255,255,255,.3) inset;
      transition: transform .06s ease, background .2s ease, opacity .2s ease; cursor: pointer;
    }
    .btn:active{ transform: translateY(1px) scale(.99); background: var(--tint-pressed); }
    .btn:disabled{ opacity: .6; cursor: not-allowed; }
    .actions{ display:flex; gap:10px; align-items:center; margin-top: 16px; }
    #msg{ flex:1; min-height: 46px; display:flex; align-items:center; padding: 10px 12px; border: 1px solid var(--line); border-radius: 16px; background: var(--tag-bg); font-size: 14px; }
    @media (max-width: 560px){ .actions{ flex-direction: column; align-items: stretch; } .btn{ width: 100%; } }

    /* KPI */
    .ink{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; margin: 6px 0 4px; }
    .ink-card{ border-radius: 16px; padding: 12px 14px; border: 1px solid var(--line); box-shadow: 0 6px 14px rgba(0,0,0,.04); }
    .ink-income{ background: var(--ink-income-bg); border-color: var(--ink-income-border); }
    .ink-expense{ background: var(--ink-expense-bg); border-color: var(--ink-expense-border); }
    .ink-balance{ background: var(--ink-balance-bg); border-color: var(--ink-balance-border); }
    .ink-label{ font-size: 13px; color: var(--muted); margin-bottom: 4px; }
    .ink-value{ font-weight: 800; font-size: clamp(18px, 3.6vw, 22px); letter-spacing: -.01em; }

    /* è¡¨æ ¼èˆ‡åœ–è¡¨ */
    .meta-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; color:var(--muted); }
    table{ width:100%; border-collapse: collapse; font-size: 14px; }
    th, td{ padding:12px 10px; border-bottom: 1px solid var(--line); text-align:left; }
    th{ color: var(--muted); font-weight:700; cursor: pointer; user-select: none; }
    .t-right{ text-align:right; white-space:nowrap; }

    .grid-2-tight{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 900px){ .grid-2-tight{ grid-template-columns: 1fr; } }
    .charts-compact{ height: 25vh; min-height: 200px; }
    canvas{ width: 100%; height: 100%; }

    /* å“ç‰Œè‰² */
    :root{ --moss: #2f6d3a; --moss-ink: #24562d; }
    html[data-theme="dark"]{ --moss: #86c28f; --moss-ink: #a8dbb0; }

    /* å·¦å´ sort æŠ½å±œï¼ˆåˆ†æé ï¼‰ */
    .flt-toggle{
      position: fixed; top:50%; transform:translateY(-50%);
      left: 6px; z-index: 35;
      border: 1px solid var(--line);
      background: var(--field-bg);
      -webkit-backdrop-filter: var(--card-blur); backdrop-filter: var(--card-blur);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px; font-weight: 700; color: var(--fg);
      box-shadow: var(--shadow); cursor: pointer;
    }
    .flt-toggle small{ opacity:.6; margin-left:4px; }

    .flt-drawer{
      position: fixed; left: 0; top: 64px; bottom: 0;
      width: var(--flt-w);
      transform: translateX(-100%); transition: transform .25s ease;
      background: var(--card);
      border-right: 1px solid var(--line);
      -webkit-backdrop-filter: var(--card-blur); backdrop-filter: var(--card-blur);
      box-shadow: var(--shadow); z-index: 34; padding: 12px;
    }
    .flt-drawer.open{ transform: translateX(0); }
    .flt-title{ font-weight:800; margin: 2px 0 10px; letter-spacing:-.01em; }
    .flt-group{ margin: 10px 0 14px; }
    .flt-label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .segmulti{ display:flex; gap:6px; flex-wrap:wrap; }
    .segmulti .segbtn{
      border:1px solid var(--field-border);
      background: var(--field-bg); color: var(--fg);
      border-radius: 12px; padding: 6px 10px; font-size: 12px; cursor:pointer;
    }
    .segmulti .segbtn.active{
      background: var(--tint); color: #fff; border-color: transparent;
      box-shadow: 0 4px 10px rgba(10,132,255,.25);
    }
    .chips{ display:flex; gap:6px; flex-wrap:wrap; }
    .chips.vertical .chip{
      display:block; width:100%; text-align:left; margin-bottom:6px;
      border:1px solid var(--field-border); background: var(--field-bg);
      color: var(--fg); border-radius: 999px; padding: 6px 8px;
      font-size: 12px; cursor:pointer;
    }
    .chip.active{
      background: color-mix(in oklab, var(--tint) 92%, white);
      color: #fff; border-color: transparent; box-shadow: 0 4px 10px rgba(10,132,255,.25);
    }

    /* sticky åœ–è¡¨ï¼ˆå¯æ”¶åˆï¼‰ */
    .insights-sticky{ position: sticky; top: 64px; z-index: 5; margin: 10px auto 12px; padding: 10px 12px; }
    .insights-sticky.collapsed .grid-2-tight{ display:none; }
    .chart-placeholder{
      display:none; align-items:center; justify-content:center;
      height: 42px; border: 1px dashed var(--line); border-radius: 12px;
      background: var(--tag-bg); color: var(--muted); font-weight:700; cursor:pointer;
    }
    .insights-sticky.collapsed .chart-placeholder{ display:flex; }
    .chart-actions{ display:flex; justify-content:flex-end; margin-top:8px; }
    .chart-toggle-btn{
      border:1px solid var(--line); background: var(--field-bg); color: var(--fg);
      border-radius: 12px; padding: 6px 10px; font-size: 13px; cursor:pointer;
    }

    /* æŠ½å±œé–‹å•Ÿæ™‚ï¼šå³å´å…§å®¹å³ç§» + ç•™ 14px é–“è· */
    #page-insights.flt-shift{ margin-left: calc(var(--flt-w) + 14px); transition: margin-left .25s ease; }

    /* è‡ªé©æ‡‰æ¯”ä¾‹çš„ logo å®¹å™¨ */
.logo-box{
  /* é è¨­å¯¬ï¼šåŸæœ¬ 180px çš„ 2 å€ = 360pxï¼›åŒæ™‚åšé»éŸ¿æ‡‰å¼ä¿è­· */
  --logo-w: 360px;
  --logo-ar: 16/9;   /* é è¨­æ¯”ä¾‹ï¼ŒçœŸæ­£æ¯”ä¾‹ç”± JS æ–¼è¼‰å…¥å¾Œè¦†è“‹ */
  --logo-radius: 16px;
  --logo-zoom: 1;    /* å¦‚éœ€åªæ”¾å¤§å½±åƒè€Œä¸æ”¹å®¹å™¨ï¼Œå¯è¨­ >1ï¼ˆä¸‹é¢ JS æˆ‘å€‘ç”¨æ”¾å¤§å°ºå¯¸ï¼Œä¸ç”¨ zoomï¼‰ */

  width: min(var(--logo-w), 90%);
  aspect-ratio: var(--logo-ar);
  margin: 0 auto 16px;
  border-radius: var(--logo-radius);
  overflow: hidden;

  /* åŸä¾†çš„ç»ç’ƒèˆ‡é™°å½±ä¿ç•™ */
  background: linear-gradient(180deg, rgba(10,132,255,.08), rgba(10,132,255,0));
  box-shadow: inset 0 1px 0 rgba(255,255,255,.25), 0 10px 24px rgba(0,0,0,.08);
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);

  display:flex; align-items:center; justify-content:center;
}

/* åœ–ç‰‡é‹ªæ»¿å®¹å™¨ä½†ä¸è£åˆ‡ï¼ˆä¿æŒå®Œæ•´ï¼‰ */
#infoLogo{
  width: 100%;
  height: 100%;
  object-fit: contain;    /* æƒ³è¦æ»¿ç‰ˆå¯æ”¹ cover */
  display: none;          /* è¼‰åˆ°æ‰é¡¯ç¤ºï¼ˆJS æœƒæ‰“é–‹ï¼‰ */
  transform: scale(var(--logo-zoom));
  transform-origin: center;
  border-radius: var(--logo-radius); /* è®“åœ“è§’å®Œå…¨å»åˆ */
}

/* è³‡è¨Šé ï¼šä»¥ logo åšç‚ºå…¨å¹…æ¨¡ç³ŠèƒŒæ™¯ï¼ˆApple éœ§é¢ç»ç’ƒé¢¨ï¼‰ */
#page-info{
  position: relative;
  isolation: isolate;           /* ç¢ºä¿å…§å¤–å±¤ç–Šå½±ä¸äº’ç›¸å½±éŸ¿ */
  border-radius: 22px;          /* å’Œ .wrap å…§å¡ç‰‡åœ“è§’æ°›åœä¸€è‡´ */
  overflow: hidden;             /* é˜²æ­¢æ¨¡ç³Šå±¤å¤–æº¢ */
}

/* å…¨å±èƒŒæ™¯ï¼šlogo åœ–æ¨¡ç³Šé‹ªæ»¿ */
body::before{
  content: "";
  position: fixed;   /* å›ºå®šæ•´å€‹è¦–çª— */
  inset: 0;
  background-image: var(--hero-img, none);
  background-size: cover;
  background-position: center;
  filter: blur(28px) saturate(130%);
  transform: scale(1.15);
  will-change: transform, filter;
  z-index: -2;       /* æ°¸é åœ¨æœ€åº•å±¤ */
}

/* ç–ŠåŠ äº®åŒ–/æš—åŒ–å±¤ï¼Œé¿å…æ–‡å­—çœ‹ä¸æ¸…æ¥š */
body::after{
  content: "";
  position: fixed;
  inset: 0;
  background:
    radial-gradient(120% 80% at 50% -20%, rgba(255,255,255,.28), transparent 55%),
    radial-gradient(120% 80% at 50% 120%, rgba(255,255,255,.22), transparent 55%),
    linear-gradient(to bottom, rgba(255,255,255,.28), rgba(255,255,255,.18));
  z-index: -1;
  opacity: var(--hero-overlay-alpha, .9);
}

/* æš—è‰²æ¨¡å¼ï¼šæ›æˆæš—è‰²é®ç½© */
html[data-theme="dark"] body::after{
  background:
    radial-gradient(120% 80% at 50% -20%, rgba(0,0,0,.38), transparent 55%),
    radial-gradient(120% 80% at 50% 120%, rgba(0,0,0,.34), transparent 55%),
    linear-gradient(to bottom, rgba(0,0,0,.38), rgba(0,0,0,.28));
}

/* æš—è‰²æ¨¡å¼ï¼šæ”¹ç”¨æš—åŒ–ç–Šè‰²ï¼Œé™ä½äº®åº¦é¿å…åˆºçœ¼ */
html[data-theme="dark"] #page-info::after{
  background:
    radial-gradient(120% 80% at 50% -20%, rgba(0,0,0,.38), transparent 55%),
    radial-gradient(120% 80% at 50% 120%, rgba(0,0,0,.34), transparent 55%),
    linear-gradient(to bottom, rgba(0,0,0,.38), rgba(0,0,0,.28));
  opacity: var(--hero-overlay-alpha, .9);
}

/* å¡ç‰‡æœ¬èº«å·²ç¶“æœ‰ç»ç’ƒæ„Ÿï¼Œç‚ºäº†æ›´åƒ iOS å¯å¾®å¢å¼· */
#page-info .card{
  -webkit-backdrop-filter: blur(14px) saturate(120%);
  backdrop-filter: blur(14px) saturate(120%);
  background: color-mix(in oklab, var(--card) 86%, transparent);
}

/* ===== åˆ†æé ï¼šç²¾ç°¡åŠ ç¸½åˆ— ===== */
.sumbar{
  display:flex; align-items:center; justify-content:space-between;
  gap:10px;
  padding: 8px 12px;            /* è–„ä¸€é»ï¼Œé¿å…ä½”é«˜ */
  border-radius: 16px;
  background: var(--card);
  border: 1px solid var(--line);
  box-shadow: var(--shadow);
  margin: 12px auto;            /* èˆ‡æ¸…å–®åŒå¯¬ï¼ˆæ”¾åœ¨ wrap > .card å‰é¢ï¼‰ */
}
.sum-left{
  display:flex; gap:6px; flex-wrap:wrap; align-items:center;
  min-height: 26px;             /* å°å°ä¸€æ¢å°±å¥½ */
}
.sum-tag{
  display:inline-flex; align-items:center; gap:6px;
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 12px; font-weight: 700;
  border:1px solid var(--field-border);
  background: var(--field-bg); color: var(--fg);
  cursor: pointer;
}
.sum-tag:hover{ filter: brightness(0.97); }
.sum-tag .x{
  font-weight: 900; opacity:.6; line-height:1; transform: translateY(-.5px);
}
.sum-right{
  font-weight: 900; font-size: 16px; white-space: nowrap;
}

/* æ²’æœ‰ç‰¹å®šé¡åˆ¥æ™‚ï¼ˆç­‰æ–¼å…¨éƒ¨ï¼‰é¡¯ç¤ºç°è‰²å¾½ç«  */
.sum-tag.is-all{
  cursor: default;
  opacity:.72;
}

/* æ—¥æœŸ pillï¼ˆå°ã€ä¸å¤–æº¢ï¼‰ */
.date-field{
  position: relative;
  width: 90px; min-width: 90px;
  border: 1px solid var(--field-border);
  background: var(--field-bg);
  border-radius: 10px;
  height: 30px;
  display:flex; align-items:center; justify-content:center;
  box-shadow: 0 1px 0 rgba(255,255,255,.25) inset;
}

.date-display{
  font-size: 12px; font-weight:700; letter-spacing:.2px;
  color: var(--fg);
  pointer-events: none;
}

/* çœŸæ­£çš„ date input ç•¶é€æ˜è¦†è“‹å±¤ï¼šå¯é»ä½†ä¸ä½”è¦–è¦ºå¯¬åº¦ */
.date-field input[type="date"]{
  position:absolute; inset:0;
  opacity:0;          /* å®Œå…¨é€æ˜ï¼Œä»å¯é»æ“Šå‘¼å«åŸç”Ÿæ—¥æœŸé¸æ“‡å™¨ */
  width:100%; height:100%;
  cursor:pointer;
}

/* ---- ä¿®æ­£ï¼šæŠ½å±œå…§æ—¥æœŸ pill ä¸è¶…å‡ºå¯¬åº¦ ---- */
.flt-drawer .row.date-row{
  gap: 6px;              /* å°ä¸€é»çš„é–“è· */
  flex-wrap: wrap;       /* å…è¨±æ›è¡Œï¼ˆæ¥µçª„æ™‚å¯ç–Šæˆå…©è¡Œï¼‰ */
}

.flt-drawer .row.date-row .date-field{
  width: calc(50% - 3px); /* å…©ç­‰åˆ†ï¼Œæ‰£æ‰é–“è·çš„ä¸€åŠ */
  min-width: 0;           /* é˜²æ­¢è¢«å…§å®¹æ’é–‹ */
}

/* å†ç²¾ç°¡ä¸€ä¸‹å…§è·èˆ‡å­—ç´šï¼Œç¢ºä¿å°æŠ½å±œä¹Ÿç©© */
.flt-drawer .date-field{ height: 28px; }
.flt-drawer .date-display{ font-size: 12px; }


  </style>
</head>
<body>
  <div class="app">
    <!-- å³å´æŠ½å±œï¼ˆé è¨­æ”¶åˆï¼‰ -->
    <aside id="sidebar" class="sidebar" aria-hidden="true">
      <div class="sb-head">
        <div class="sb-title">æƒ å®‡ç¢§æŸ³</div>
        <button id="sbClose" class="sb-close" type="button" title="é—œé–‰">â‡¤</button>
      </div>
      <div class="sb-group">
        <button class="sb-link" data-nav="info"><strong>è³‡è¨Š</strong></button>
        <button class="sb-link" data-nav="home"><strong>è¨˜å¸³</strong></button>
        <button class="sb-link" data-nav="insights"><strong>åˆ†æ</strong></button>
      </div>
      <div class="sb-foot">v10 Â· iOS äº®/æš—</div>
    </aside>

    <!-- å…§å®¹å€ -->
    <main class="content">
      <div class="topbar">
        <div class="topbar-row">
          <div class="large-title">ç¢§æŸ³è¨˜å¸³å†Š <span class="subtitle" id="meta"></span></div>
          <div class="rightbar">
            <div class="theme-toggle" aria-label="ä¸»é¡Œåˆ‡æ›">
              <div class="seg-sm" role="tablist">
                <button id="thLight" class="active" type="button">äº®</button>
                <button id="thDark"  type="button">æš—</button>
              </div>
            </div>
            <button id="btnMenu" class="menu-btn" type="button">â˜° Menu</button>
          </div>
        </div>
        <div class="topbar-center">
          <div class="page-name" id="pageName">è³‡è¨Š</div>
        </div>
      </div>

      <!-- Page: Info -->
      <section id="page-info" class="wrap" hidden>
        <div class="card" style="text-align:center; padding-top:28px;">
          <!-- logoï¼šè‡ªé©æ‡‰æ¯”ä¾‹ + åœ“è§’ä¸€è‡´ -->
          <div class="logo-box">
            <img id="infoLogo" alt="logo">
          </div>

          <h1 style="font-size:clamp(28px,4.6vw,38px); margin:6px 0 4px; letter-spacing:-.02em; font-weight:800; color:var(--moss-ink);">
            æƒ å®‡ç¢§æŸ³
          </h1>

          <!-- ä¸­æ–‡åœ°å€ + è‹±æ–‡åœ°å€ï¼ˆè‹±æ–‡å¾åŸæ¨™é¡Œåˆ—æ¬ä¾†é€™è£¡ï¼‰ -->
          <div style="color:var(--muted); font-weight:600; margin-bottom:14px; line-height:1.5;">
            <div>406015 å°ä¸­å¸‚åŒ—å±¯å€è©”å®‰è¡—88è™Ÿ4æ¨“ä¹‹21</div>
            <div id="addrEn">4F-21, No. 88, Zhao'an Street, Beitun District, Taichung City 406015, Taiwan (R.O.C.)</div>
          </div>

          <div class="row" style="justify-content:center; gap:14px;">
            <div class="col" style="max-width:520px;">
              <div class="card" style="margin:0; text-align:left;">
                <div style="font-size:14px; color:var(--muted); margin-bottom:10px;">è²¸æ¬¾è³‡è¨Š</div>
                <div style="display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;">
                  <div>å·²ç¹³è²¸æ¬¾</div>
                  <div id="loanPaid" style="font-weight:800;">â€”</div>

                  <div>ç¸½é¡æˆ¿å±‹è²¸æ¬¾</div>
                  <div id="loanTotal" style="font-weight:800;">12,000,000</div>

                  <div>é€²åº¦</div>
                  <div id="loanPct" style="font-weight:800;">â€”%</div>
                </div>

                <!-- è¦–è¦ºåŒ–é€²åº¦æ¢ -->
                <div style="margin-top:12px;height:10px;border-radius:999px; background:color-mix(in oklab, var(--muted) 12%, transparent); position:relative; overflow:hidden;">
                  <div id="loanBar" style="position:absolute; left:0; top:0; bottom:0; width:0%;
                       background:linear-gradient(90deg, var(--moss), color-mix(in oklab, var(--moss) 60%, var(--tint)));
                       border-radius:999px; box-shadow:0 6px 16px rgba(0,0,0,.08);"></div>
                </div>

                <!-- æ–°å¢ï¼šç›®å‰é¤˜é¡ -->
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                  <div style="color:var(--muted); font-size:14px;">ç›®å‰é¤˜é¡</div>
                  <div id="loanBalance" style="font-weight:800;">â€”</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Page: Homeï¼ˆè¡¨å–® + KPIï¼‰ -->
      <section id="page-home" class="wrap">
        <div class="card">
          <form id="f" autocomplete="off">
            <div class="row">
              <div class="col">
                <label>æ—¥æœŸ</label>
                <input type="date" name="date" required />
              </div>
              <div class="col">
                <label>é …ç›®åç¨±</label>
                <input type="text" name="title" placeholder="ä¾‹å¦‚ï¼šæˆ¿è²¸ / ç©ºèª¿å°¾æ¬¾â€¦" required />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <div class="col">
                <label>é …ç›®é¡åˆ¥</label>
                <select name="category" id="category" required>
                  <option value="" disabled selected>è«‹é¸æ“‡</option>
                </select>
              </div>

              <div class="col">
                <label>æ”¶å…¥ / æ”¯å‡º</label>
                <div class="seg" role="tablist" aria-label="æ”¶å…¥æˆ–æ”¯å‡º">
                  <input type="radio" id="typeOut"  name="type" value="æ”¯å‡º" checked>
                  <label for="typeOut">æ”¯å‡º</label>
                  <input type="radio" id="typeIn"   name="type" value="æ”¶å…¥">
                  <label for="typeIn">æ”¶å…¥</label>
                </div>
              </div>

              <div class="col">
                <label>é‡‘é¡</label>
                <input type="number" inputmode="numeric" step="1" min="0" name="amount" placeholder="0" required />
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <div class="col">
                <label>ä»˜æ¬¾äºº</label>
                <select name="payer" id="payer" required>
                  <option value="" disabled selected>è«‹é¸æ“‡</option>
                </select>
              </div>
            </div>

            <div class="actions">
              <button id="submitBtn" class="btn" type="submit">æ–°å¢</button>
              <span id="msg"></span>
            </div>
          </form>
        </div>

        <div class="card">
          <h3 class="subtitle" style="margin:0 0 8px;">ç›®å‰é¤˜é¡</h3>
          <div class="ink">
            <div class="ink-card ink-income">
              <div class="ink-label">ç¸½æ”¶å…¥</div>
              <div class="ink-value" id="inkIncome">â€”</div>
            </div>
            <div class="ink-card ink-expense">
              <div class="ink-label">ç¸½æ”¯å‡º</div>
              <div class="ink-value" id="inkExpense">â€”</div>
            </div>
            <div class="ink-card ink-balance">
              <div class="ink-label">ç›®å‰é¤˜é¡</div>
              <div class="ink-value" id="inkBalance">â€”</div>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button id="refreshBtn" class="btn" type="button">é‡æ–°æ•´ç†</button>
          </div>
        </div>
      </section>

      <!-- Page: Insightsï¼ˆå·¦æŠ½å±œç¯©é¸ + sticky ç¸®é«˜åœ– + æ¸…å–®ï¼‰ -->
      <section id="page-insights" class="wrap" hidden>
        <!-- å·¦å´ sort æŠ½å±œ toggle -->
        <button id="fltToggle" class="flt-toggle" type="button">â‡¥ <small>sort</small></button>

        <!-- å·¦å´æŠ½å±œ -->
        <aside id="fltDrawer" class="flt-drawer" aria-hidden="true">
          <div class="flt-title">ç¯©é¸</div>

          <div class="flt-group">
            <div class="flt-label">æ—¥æœŸå€é–“</div>
            <div class="row date-row" style="gap:8px;">
              <div class="date-field">
                <span class="date-display" id="dispFrom">â€”/â€”</span>
                <input type="date" id="fltFrom" aria-label="èµ·æ—¥">
              </div>
              <div class="date-field">
                <span class="date-display" id="dispTo">â€”/â€”</span>
                <input type="date" id="fltTo" aria-label="è¿„æ—¥">
              </div>
            </div>

            <div class="segmulti" style="margin-top:8px;">
              <button type="button" class="segbtn" data-q="this-month">æœ¬æœˆ</button>
              <button type="button" class="segbtn" data-q="all">å…¨éƒ¨</button>
            </div>
          </div>

          <div class="flt-group">
            <div class="flt-label">æ”¶å…¥ / æ”¯å‡ºï¼ˆå¯è¤‡é¸ï¼‰</div>
            <div id="segType" class="segmulti">
              <button type="button" class="segbtn active" data-type="æ”¶å…¥">æ”¶å…¥</button>
              <button type="button" class="segbtn active" data-type="æ”¯å‡º">æ”¯å‡º</button>
            </div>
          </div>

          <div class="flt-group">
            <div class="flt-label">é¡åˆ¥ï¼ˆå¯è¤‡é¸ï¼‰</div>
            <div id="chipsCat" class="chips vertical"></div>
          </div>

          <div class="flt-group">
            <div class="flt-label">ä»˜æ¬¾äººï¼ˆå¯è¤‡é¸ï¼‰</div>
            <div id="chipsPayer" class="chips vertical"></div>
          </div>
        </aside>

        <!-- sticky åœ–è¡¨ï¼ˆå·¦ï¼šåˆ†é¡é•·æ¢ï½œå³ï¼šæ™‚é–“ç´¯ç©ï¼‰ -->
        <div class="card insights-sticky" id="chartsBox">
          <h3 class="subtitle" style="margin:0 0 6px;">é¡åˆ¥åŠ ç¸½ï¼ˆå·¦ï¼šåˆ†é¡ï½œå³ï¼šæ™‚é–“ç´¯ç©ï¼‰</h3>
          <div class="chart-placeholder" id="chartPlaceholder">é»é¸é–‹å•Ÿåœ–è¡¨</div>
          <div class="grid-2-tight" id="chartsGrid">
            <div class="charts-compact"><canvas id="chartFeatured"></canvas></div>
            <div class="charts-compact"><canvas id="chartOthers"></canvas></div>
          </div>
          <div class="chart-actions">
            <button id="btnChartToggle" type="button" class="chart-toggle-btn">æ”¶åˆåœ–è¡¨</button>
          </div>
        </div>

        <!-- åˆ†æé ï¼šç¯©é¸åŠ ç¸½åˆ—ï¼ˆæ”¾åœ¨æ¸…å–®ä¸Šæ–¹ï¼‰ -->
        <div class="sumbar" id="sumBar">
          <div class="sum-left" id="sumTags"><!-- é¡åˆ¥å°æ°£æ³¡æœƒç”± JS æ³¨å…¥ --></div>
          <div class="sum-right"><span id="sumTotal">â€”</span></div>
        </div>

        <!-- æ¸…å–® -->
        <div class="card">
          <div class="meta-row">
            <div>æ¸…å–®ï¼ˆ<span id="rowCount">0</span> ç­†ï¼‰</div>
            <div id="rowsMsg" class="subtitle"></div>
          </div>
          <div style="overflow:auto;">
            <table id="tbl">
              <thead>
                <tr>
                  <th data-k="date">æ—¥æœŸ</th>
                  <th data-k="title">é …ç›®åç¨±</th>
                  <th data-k="category">é¡åˆ¥</th>
                  <th data-k="amount" class="t-right">é‡‘é¡</th>
                  <th data-k="type">æ”¶å…¥/æ”¯å‡º</th>
                  <th data-k="payer">ä»˜æ¬¾äºº</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

// ---- æ—¥æœŸé¡¯ç¤ºï¼šæŠŠ input çš„å€¼è½‰æˆ MM/DD é¡¯ç¤ºåœ¨ç›¸é„° .date-display ----
function bindShortDate(inpId, dispId){
  const inp = document.getElementById(inpId);
  const disp = document.getElementById(dispId);
  if (!inp || !disp) return;
  const sync = ()=>{
    if (inp.value) {
      const [y,m,d] = inp.value.split('-');
      disp.textContent = `${m}/${d}`;
    } else {
      disp.textContent = 'â€”/â€”';
    }
  };
  inp.addEventListener('change', ()=>{ sync(); applyFilters(); });
  inp.addEventListener('input',  sync);
  sync();
}

// åˆå§‹åŒ–ï¼ˆæ”¾åœ¨ä½  loadRows() ä¹‹å¾Œæˆ–è·¯ç”±åˆ‡åˆ° insights å¾Œï¼‰
bindShortDate('fltFrom','dispFrom');
bindShortDate('fltTo','dispTo');

// å¿«æ·éµï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„ data-q é‚è¼¯ï¼Œè¨˜å¾—åˆ·æ–°é¡¯ç¤ºï¼‰
document.querySelectorAll('.segbtn[data-q]').forEach(btn=>{
  btn.onclick = ()=>{
    const tag = btn.dataset.q;
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();

    if (tag === 'this-month'){
      const from = new Date(y, m, 1).toISOString().slice(0,10);
      const to   = new Date(y, m+1, 0).toISOString().slice(0,10);
      document.getElementById('fltFrom').value = from;
      document.getElementById('fltTo').value   = to;
    } else { // 'all'
      document.getElementById('fltFrom').value = '';
      document.getElementById('fltTo').value   = '';
    }
    // æ›´æ–°é¡¯ç¤º + è§¸ç™¼ç¯©é¸
    const ev = new Event('change');
    document.getElementById('fltFrom').dispatchEvent(ev);
    document.getElementById('fltTo').dispatchEvent(ev);
  };
});

  // ===== ä¸»é¡Œåˆ‡æ› =====
  const root = document.documentElement;
  const thLight = $('#thLight'), thDark = $('#thDark');
  function setTheme(mode){
    root.setAttribute('data-theme', mode === 'dark' ? 'dark' : 'light');
    localStorage.setItem('theme-mode', mode);
    [thLight, thDark].forEach(b=>b.classList.remove('active'));
    (mode === 'dark' ? thDark : thLight).classList.add('active');
  }
  setTheme(localStorage.getItem('theme-mode') || 'light');
  thLight.onclick = ()=> setTheme('light');
  thDark.onclick  = ()=> setTheme('dark');

  // ===== å³å´æŠ½å±œï¼ˆä¸»é¸å–®ï¼‰ =====
  const sidebar = $('#sidebar');
  $('#btnMenu').addEventListener('click', ()=>{
    const open = sidebar.classList.toggle('open');
    sidebar.setAttribute('aria-hidden', open ? 'false' : 'true');
  });
  $('#sbClose').addEventListener('click', ()=>{
    sidebar.classList.remove('open');
    sidebar.setAttribute('aria-hidden','true');
  });
  $$('.sb-link').forEach(b=> b.addEventListener('click', ()=>{
    location.hash = '#' + b.dataset.nav;
    sidebar.classList.remove('open');
    sidebar.setAttribute('aria-hidden','true');
  }));

  // ===== Topbar metaï¼šåªé¡¯ç¤ºä»Šæ—¥æ—¥æœŸï¼ˆåœ°å€ç§»é™¤ï¼‰ =====
  const meta = $('#meta');
  (function showTopDate(){
    const todayStr = new Intl.DateTimeFormat('zh-TW', {
      timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit'
    }).format(new Date());
    meta.textContent = todayStr;
  })();

  // ===== è¡¨å–®ï¼ˆè¨˜å¸³ï¼‰ =====
  const f = $('#f'), msg = $('#msg'), submitBtn = $('#submitBtn');
  const selCat = $('#category'), selPayer = $('#payer');
  const today = new Date();
  const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);
  if (f) f.date.value = iso;
  function tip(text){ if (!msg) return; msg.textContent = text||''; if (text) setTimeout(()=> msg.textContent='', 2500); }
  function fmt(n){ return (Number(n||0)).toLocaleString(); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function loadOptions(){
    google.script.run
      .withSuccessHandler(opt=>{
        if (selCat)  fillSelect(selCat,  (opt && opt.categories) || []);
        if (selPayer)fillSelect(selPayer,(opt && opt.payers)    || []);
      })
      .withFailureHandler(err=> console.warn('readOptions fail:', err && err.message))
      .readOptions();
  }
  function fillSelect(sel, arr){
    sel.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡</option>` +
      arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  }
  loadOptions();

  if (f){
    f.addEventListener('submit', (e)=>{
      e.preventDefault();
      submitBtn.disabled = true; tip('é€å‡ºä¸­â€¦');
      const payload = Object.fromEntries(new FormData(f).entries());
      google.script.run
        .withSuccessHandler(()=>{
          tip('å·²æ–°å¢ âœ…');
          f.reset(); f.date.value = iso;
          refreshTotals(); loadOptions();
          if (!$('#page-insights').hidden) { loadRows(); refreshCharts(); }
          submitBtn.disabled = false;
        })
        .withFailureHandler(err=>{
          tip('å¤±æ•—ï¼š' + (err && err.message || err));
          submitBtn.disabled = false;
        })
        .writeEntry(payload);
    });
  }

  // KPI
  function renderKpis(d){
    $('#inkIncome').textContent  = fmt(d.totalIncome);
    $('#inkExpense').textContent = fmt(d.totalExpense);
    $('#inkBalance').textContent = fmt(d.balance);
  }
  function refreshTotals(){
    google.script.run.withSuccessHandler(renderKpis).readTotals();
  }
  $('#refreshBtn')?.addEventListener('click', ()=>{ refreshTotals(); loadOptions(); });
  refreshTotals();

  // ===== Info é ï¼šlogo + è²¸æ¬¾é€²åº¦ + ç›®å‰é¤˜é¡ =====
  function loadInfo(){
      // 1) è®€ logo
      google.script.run.withSuccessHandler(res => {
        const img = document.getElementById('infoLogo');
        const url = (res && res.url || '').trim();
        const box = img?.closest('.logo-box');        // ä½ ä¸Šä¸€ç‰ˆæœ‰çš„ logo å®¹å™¨ï¼ˆè‹¥æ²’ç”¨ logo-box ä¹Ÿæ²’é—œä¿‚ï¼‰
        const infoSection = document.getElementById('page-info');
        if (!img || !url || !infoSection) return;

        img.onload = () => {
          // è¨­å®šè³‡è¨Šé èƒŒæ™¯ä½¿ç”¨åŒä¸€å¼µåœ–ç‰‡
          infoSection.style.setProperty('--hero-img', `url("${url}")`);
          // è¦–éœ€è¦å¯èª¿æ•´æ•´é«”é€æ˜åº¦ï¼ˆ0~1ï¼‰
          infoSection.style.setProperty('--hero-overlay-alpha', '0.92');

          // ä½ çš„è‡ªé©æ‡‰ logo å¯¬é«˜æ¯”ä¾‹èˆ‡å…©å€å°ºå¯¸è¨­å®šï¼ˆä¿æŒåŸé‚è¼¯ï¼‰
          const nw = img.naturalWidth || 1;
          const nh = img.naturalHeight || 1;
          const boxEl = box || img.parentElement;
          if (boxEl){
            boxEl.style.setProperty('--logo-ar', `${nw}/${nh}`);
            boxEl.style.setProperty('--logo-w', '360px'); // 2x å°ºå¯¸
          }
          img.style.display = 'block';
        };

        img.onerror = () => {
          console.warn('logo è¼‰å…¥å¤±æ•—ï¼š', url);
          // èƒŒæ™¯ä¹Ÿå°±ä¸è¨­äº†ï¼Œä¿æŒåŸæœ¬åº•è‰²
        };

        img.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();

         // ğŸ’¡ é‡é»ï¼šè¨­å®šå…¨å±èƒŒæ™¯ç”¨çš„ CSS è®Šæ•¸
        document.body.style.setProperty('--hero-img', `url("${url}")`);
        document.body.style.setProperty('--hero-overlay-alpha', '0.92');

      }).getLogoUrl();

      // 2) è®€è²¸æ¬¾é€²åº¦ï¼ˆç¶­æŒåŸæœ¬ï¼‰
      google.script.run
        .withSuccessHandler(d=>{
          const fN = n => (Number(n||0)).toLocaleString();
          document.getElementById('loanPaid').textContent  = fN(d.paid);
          document.getElementById('loanTotal').textContent = fN(d.total);
          document.getElementById('loanPct').textContent   = (d.percent ?? 0) + '%';
          document.getElementById('loanBar').style.width   =
            Math.max(0, Math.min(100, Number(d.percent || 0))) + '%';
        })
        .withFailureHandler(err=> console.warn('readLoanProgress fail:', err && err.message || err))
        .readLoanProgress();

      // 3) ç›®å‰é¤˜é¡
      google.script.run
        .withSuccessHandler(t => {
          document.getElementById('loanBalance').textContent =
            (Number(t?.balance||0)).toLocaleString();
        })
        .withFailureHandler(() => {
          document.getElementById('loanBalance').textContent = 'â€”';
        })
        .readTotals();
    }

  // ===== åˆ†æé  =====
  const tblBody  = $('#tbl tbody');
  const rowCount = $('#rowCount');
  const rowsMsg  = $('#rowsMsg');
  let currentRows = [];
  let filteredRows = [];
  let sortState = { key:'date', dir:'desc' };
  let chartFeatured, chartOthers;

  // å·¦å´ sort æŠ½å±œ
  const fltToggle    = document.getElementById('fltToggle');
  const fltDrawer    = document.getElementById('fltDrawer');
  const pageInsights = document.getElementById('page-insights');

  function setDrawer(open){
    if (!fltDrawer || !fltToggle || !pageInsights) return;
    const willOpen = !!open;
    fltDrawer.classList.toggle('open', willOpen);
    fltDrawer.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
    pageInsights.classList.toggle('flt-shift', willOpen);
    fltToggle.style.left = willOpen ? `calc(var(--flt-w) + 6px)` : '6px';
    fltToggle.innerHTML  = willOpen ? 'â‡¤' : 'â‡¥ <small>sort</small>';
  }
  fltToggle?.addEventListener('click', ()=> setDrawer(!fltDrawer.classList.contains('open')));

  // ç¯©é¸æ§åˆ¶ï¼ˆchips + segmentedï¼‰
  const fltFrom   = document.getElementById('fltFrom');
  const fltTo     = document.getElementById('fltTo');
  const segType   = document.getElementById('segType');
  const chipsCat  = document.getElementById('chipsCat');
  const chipsPayer= document.getElementById('chipsPayer');

  const DEFAULT_CATS = new Set(['æˆ¿è²¸','æ°´é›»è²»','è¨­å‚™']);
  let selectedTypes  = new Set(['æ”¶å…¥','æ”¯å‡º']);
  let selectedCats   = new Set(DEFAULT_CATS);
  let selectedPayers = new Set();

  function makeChip(text, on){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'chip' + (on ? ' active' : '');
    b.textContent = text;
    b.dataset.val = text;
    b.addEventListener('click', ()=>{ b.classList.toggle('active'); applyFilters(); });
    return b;
  }

  function buildChipsFromData(rows){
    const cats   = Array.from(new Set(rows.map(r=> r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰'))).sort();
    const payers = Array.from(new Set(rows.map(r=> r.payer    || 'ï¼ˆæœªå¡«ï¼‰'))).sort();

    chipsCat.innerHTML = '';
    selectedCats = new Set();
    cats.forEach(c=>{
      const on = DEFAULT_CATS.has(c);
      if (on) selectedCats.add(c);
      chipsCat.appendChild(makeChip(c, on));
    });

    chipsPayer.innerHTML = '';
    selectedPayers = new Set(payers);
    payers.forEach(p=> chipsPayer.appendChild(makeChip(p, true)));

    // æ”¶å…¥/æ”¯å‡ºï¼ˆå¯è¤‡é¸ï¼‰
    segType.querySelectorAll('.segbtn').forEach(btn=>{
      btn.onclick = ()=>{
        const v = btn.dataset.type;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) selectedTypes.add(v);
        else selectedTypes.delete(v);
        if (selectedTypes.size === 0){ selectedTypes.add(v); btn.classList.add('active'); }
        applyFilters();
      };
    });

    fltFrom.onchange = applyFilters;
    fltTo.onchange   = applyFilters;

  }

  function loadRows(){
    if (!tblBody) return;
    rowsMsg.textContent = 'è¼‰å…¥ä¸­â€¦';
    google.script.run
      .withSuccessHandler(res=>{
        const raw = Array.isArray(res?.rows) ? res.rows : [];
        currentRows = raw.map(r=>{
          const amt = Number(String(r.amount||'').replace(/,/g,'').trim()) || 0;
          let d = null;
          if (r.dateStr){
            const m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            d = m ? new Date(+m[1], +m[2]-1, +m[3]) : new Date(r.dateStr);
          }
          if (!(d instanceof Date) || isNaN(d)) d = new Date(0);
          return { ...r, amount: amt, date: d };
        });

        buildChipsFromData(currentRows);
        fltFrom.value = ''; fltTo.value = '';   // é è¨­ã€Œå…¨éƒ¨ã€
        setDrawer(false);                       // é è¨­æ”¶åˆ
        applyFilters();
        rowsMsg.textContent = '';
      })
      .withFailureHandler(err=>{
        rowsMsg.textContent = 'è®€å–å¤±æ•—ï¼š' + (err?.message || err);
        console.error('readRowsLatest fail:', err);
      })
      .readRowsLatest(1000);
  }

  function renderTable(rowsIn){
    const rows = [...(rowsIn||[])].sort((a,b)=>{
      const k = sortState.key, dir = sortState.dir === 'asc' ? 1 : -1;
      let va = a[k], vb = b[k];
      if (k === 'amount') { va = Number(va||0); vb = Number(vb||0); }
      if (k === 'date' || k === 'dateStr') {
        va = new Date(a.dateStr || a.date); vb = new Date(b.dateStr || b.date);
      }
      if (va < vb) return -1 * dir;
      if (va > vb) return  1 * dir;
      return 0;
    });
    tblBody.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.dateStr || '')}</td>
        <td>${escapeHtml(r.title || '')}</td>
        <td>${escapeHtml(r.category || '')}</td>
        <td class="t-right">${(Number(r.amount||0)).toLocaleString()}</td>
        <td>${escapeHtml(r.type || '')}</td>
        <td>${escapeHtml(r.payer || '')}</td>
      </tr>
    `).join('');
  }
  $$('#tbl thead th').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.k; if (!k) return;
      if (sortState.key === k) sortState.dir = (sortState.dir === 'asc' ? 'desc' : 'asc');
      else { sortState.key = k; sortState.dir = 'asc'; }
      renderTable(filteredRows);
    });
  });

  function drawChartsFromRows(rows){
    // å·¦åœ–ï¼šåˆ†é¡é•·æ¢ï¼ˆå«æ•¸å€¼æ¨™ç±¤ï¼‰
    const byCat = {};
    rows.forEach(r=>{
      const c = (r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰').trim();
      if (!byCat[c]) byCat[c] = { inc:0, exp:0, tot:0 };
      const n = Number(r.amount||0) || 0;
      if (r.type === 'æ”¶å…¥') byCat[c].inc += n; else byCat[c].exp += n;
      byCat[c].tot += n;
    });
    const catSorted = Object.entries(byCat).sort((a,b)=> b[1].tot - a[1].tot);
    const L = { labels: catSorted.map(([k])=>k),
                inc:    catSorted.map(([,v])=>v.inc),
                exp:    catSorted.map(([,v])=>v.exp) };

    // å³åœ–ï¼šæ™‚é–“è»¸ã€Œç´¯ç©ã€æŠ˜ç·šï¼ˆé¡åˆ¥è»¸é¿å… adapter éœ€æ±‚ï¼‰
    const daily = new Map(); // yyyy-MM-dd -> {inc,exp}
    const toDate = r=>{
      if (r.dateStr){
        const m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
        return m ? new Date(Number(m[1]), Number(m[2])-1, Number(m[3])) : new Date(r.dateStr);
      }
      return r.date ? new Date(r.date) : new Date(0);
    };
    [...rows].sort((a,b)=> toDate(a) - toDate(b)).forEach(r=>{
      const d = toDate(r); if (!(d instanceof Date) || isNaN(d)) return;
      const k = d.toISOString().slice(0,10);
      if (!daily.has(k)) daily.set(k,{inc:0,exp:0});
      const v = daily.get(k), n = Number(r.amount||0) || 0;
      if (r.type === 'æ”¶å…¥') v.inc += n; else v.exp += n;
    });
    const labelsT = Array.from(daily.keys()).sort();
    let accInc = 0, accExp = 0;
    const seriesInc = [], seriesExp = [];
    labelsT.forEach(k=>{ const v = daily.get(k); accInc += v.inc; accExp += v.exp; seriesInc.push(accInc); seriesExp.push(accExp); });

    // é‡ç•«
    if (chartFeatured) chartFeatured.destroy();
    if (chartOthers)   chartOthers.destroy();

    // æŸ±é ‚æ•¸å€¼æ¨™ç±¤
    const valueLabelPlugin = {
      id: 'valueLabel',
      afterDatasetsDraw(chart){
        const {ctx} = chart;
        ctx.save();
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans"';
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg') || '#111';
        chart.data.datasets.forEach((dset, di)=>{
          const meta = chart.getDatasetMeta(di);
          if (meta.type !== 'bar') return;
          meta.data.forEach((bar, i)=>{
            const val = dset.data[i]; if (val == null) return;
            const p = bar.tooltipPosition();
            ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
            ctx.fillText(Number(val).toLocaleString(), p.x, p.y - 4);
          });
        });
        ctx.restore();
      }
    };

    chartFeatured = new Chart(document.getElementById('chartFeatured').getContext('2d'), {
      type: 'bar',
      data: { labels: L.labels, datasets: [
        { label:'æ”¶å…¥', data: L.inc,  borderWidth:1 },
        { label:'æ”¯å‡º', data: L.exp,  borderWidth:1 }
      ]},
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'top' } } },
      plugins: [valueLabelPlugin]
    });

    const typesNow = new Set(Array.from(document.querySelectorAll('#segType .segbtn.active')).map(b=>b.dataset.type));
    const datasetsT = [];
    if (typesNow.has('æ”¶å…¥')) datasetsT.push({ label:'æ”¶å…¥(ç´¯ç©)', data: seriesInc, borderWidth:2, type:'line' });
    if (typesNow.has('æ”¯å‡º')) datasetsT.push({ label:'æ”¯å‡º(ç´¯ç©)', data: seriesExp, borderWidth:2, type:'line' });

    chartOthers = new Chart(document.getElementById('chartOthers').getContext('2d'), {
      type: 'line',
      data: { labels: labelsT, datasets: datasetsT },
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }, x:{ type:'category' } }, plugins:{ legend:{ position:'top' } } }
    });
  }

  function refreshCharts(){ drawChartsFromRows(filteredRows.length ? filteredRows : currentRows); }

  function applyFilters(){
    const getAct = sel => Array.from(sel.querySelectorAll('.active')).map(b=> b.dataset.val || b.dataset.type);
    const cats   = new Set(getAct(chipsCat));
    const pays   = new Set(getAct(chipsPayer));
    const types  = new Set(getAct(segType));
    const from = fltFrom.value ? new Date(fltFrom.value + 'T00:00:00') : null;
    const to   = fltTo.value   ? new Date(fltTo.value   + 'T23:59:59') : null;

    filteredRows = currentRows.filter(r=>{
      const d = r.dateStr ? new Date(r.dateStr.replace(/\./g,'/')) : (r.date ? new Date(r.date) : null);
      if (from && d && d < from) return false;
      if (to   && d && d > to)   return false;
      const c = r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰';
      const p = r.payer    || 'ï¼ˆæœªå¡«ï¼‰';
      const t = r.type     || '';
      if (cats.size  && !cats.has(c))  return false;
      if (pays.size  && !pays.has(p))  return false;
      if (types.size && !types.has(t)) return false;
      return true;
    });

    rowCount.textContent = String(filteredRows.length);
    renderTable(filteredRows);
    refreshCharts();

    renderSumBar();
  }

  // ===== åœ–è¡¨æ”¶åˆ/å±•é–‹ =====
  const chartsBox   = document.getElementById('chartsBox');
  const chartPh     = document.getElementById('chartPlaceholder');
  const btnChartTgl = document.getElementById('btnChartToggle');

  function setChartsCollapsed(on){
    chartsBox.classList.toggle('collapsed', !!on);
    btnChartTgl.textContent = on ? 'å±•é–‹åœ–è¡¨' : 'æ”¶åˆåœ–è¡¨';
    setTimeout(()=>{ chartFeatured?.resize(); chartOthers?.resize(); }, 0);
  }
  btnChartTgl?.addEventListener('click', ()=>{
    const on = !chartsBox.classList.contains('collapsed');
    setChartsCollapsed(on);
  });
  chartPh?.addEventListener('click', ()=> setChartsCollapsed(false));

  // ===== è·¯ç”± + åˆ†é åç¨± =====
  const pageNameEl = document.getElementById('pageName');
  const pageNames  = { info:'è³‡è¨Š', home:'è¨˜å¸³', insights:'åˆ†æ' };

  function showPage(name){
    $('#page-info').hidden     = (name !== 'info');
    $('#page-home').hidden     = (name !== 'home');
    $('#page-insights').hidden = (name !== 'insights');
    $$('.sb-link').forEach(b=> b.classList.toggle('active', b.dataset.nav === name));
    pageNameEl.textContent = pageNames[name] || '';
    if (name === 'insights') { setDrawer(false); loadRows(); }
    if (name === 'info')     { loadInfo(); }
  }
  function applyHash(){
    const h = (location.hash || '#info').replace('#','');
    showPage(['info','home','insights'].includes(h) ? h : 'info');
  }
  window.addEventListener('hashchange', applyHash);
  applyHash();

/* === åˆ†æé ï¼šåŠ ç¸½åˆ— ===
   - é¡¯ç¤ºç›®å‰ã€Œé¡åˆ¥ã€çš„é¸å–ï¼ˆ= å·¦æŠ½å±œ chips çš„ activeï¼‰
   - å³å´é¡¯ç¤ºé‡‘é¡åˆè¨ˆï¼ˆåœ¨ filteredRows åŸºç¤ä¸Šå†ä¾é¡åˆ¥èšåˆï¼‰
   - é»æ°£æ³¡ â†’ å–æ¶ˆè©²é¡åˆ¥ï¼ˆç­‰åŒå–æ¶ˆå·¦æŠ½å±œ chipï¼‰ä¸¦é‡ç®—
*/
function renderSumBar(){
  const sumTagsBox = document.getElementById('sumTags');
  const sumTotalEl = document.getElementById('sumTotal');
  if (!sumTagsBox || !sumTotalEl) return;

  // ç›®å‰ã€Œæœ‰è¢«é¸ä¸­ã€çš„é¡åˆ¥ï¼ˆ= å·¦æŠ½å±œ chips.activeï¼‰
  const activeCats = Array.from(document.querySelectorAll('#chipsCat .chip.active'))
    .map(b => b.dataset.val);

  // å¦‚æœæ²’æœ‰ä»»ä½•é¡åˆ¥è¢«é¸ä¸­ï¼Œèªæ„ä¸Šï¼å…¨éƒ¨é¡åˆ¥
  const usingAll = activeCats.length === 0;

  // æº–å‚™è¦é¡¯ç¤ºåœ¨å·¦é‚Šçš„å°æ°£æ³¡å€‘
  sumTagsBox.innerHTML = '';
  if (usingAll){
    const tag = document.createElement('span');
    tag.className = 'sum-tag is-all';
    tag.textContent = 'å…¨éƒ¨é¡åˆ¥';
    sumTagsBox.appendChild(tag);
  } else {
    activeCats.forEach(cat=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'sum-tag';
      btn.innerHTML = `<span>${cat}</span><span class="x">Ã—</span>`;
      btn.addEventListener('click', ()=>{
        // å–æ¶ˆå·¦æŠ½å±œå°æ‡‰ chip çš„ active
        const chip = Array.from(document.querySelectorAll('#chipsCat .chip'))
          .find(c => c.dataset.val === cat);
        if (chip){ chip.classList.remove('active'); }
        applyFilters(); // æœƒé †ä¾¿é‡ç•«è¡¨æ ¼/åœ–è¡¨/åŠ ç¸½åˆ—
      });
      sumTagsBox.appendChild(btn);
    });
  }

  // è¨ˆç®—åŠ ç¸½ï¼šåœ¨ã€Œå·²å¥—ç”¨å…¶ä»–æ¢ä»¶ã€çš„ filteredRows è£¡å†æ ¹æ“š activeCats åˆè¨ˆ
  let total = 0;
  // ç•¶ä½¿ç”¨ã€Œå…¨éƒ¨ã€æ™‚ï¼Œå®¹è¨±æ‰€æœ‰é¡åˆ¥ï¼›å¦å‰‡åªç®— activeCats å…§çš„
  const allowSet = usingAll
    ? null
    : new Set(activeCats);

  filteredRows.forEach(r=>{
    const cat = (r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰').trim();
    if (allowSet && !allowSet.has(cat)) return;
    // é€™è£¡ä»¥ã€Œé‡‘é¡ç›¸åŠ ã€ç‚ºæº–ï¼ˆä¸è«–æ”¶å…¥/æ”¯å‡ºï¼‰
    // è‹¥ä½ è¦æŠŠæ”¯å‡ºè¦–ç‚ºè² æ•¸ï¼Œæ”¹æˆï¼šconst val = (r.type === 'æ”¯å‡º' ? -1 : 1) * Number(r.amount||0)
    const val = Number(r.amount || 0);
    total += val;
  });

  sumTotalEl.textContent = total.toLocaleString();
}
  
})();
</script>
</body>
</html>