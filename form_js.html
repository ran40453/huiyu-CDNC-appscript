<script>

(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // ---- 通用：點擊 data-copy 複製指定節點的文字 ----
  function bindCopyDelegation(){
    document.addEventListener('click', function(e){
      var btn = e.target.closest('[data-copy]');
      if (!btn) return;
      var sel = btn.getAttribute('data-copy');
      var el  = sel ? document.querySelector(sel) : null;
      if (!el) return;
      var txt = (el.textContent || '').trim();
      if (!txt) return;
      (navigator.clipboard && navigator.clipboard.writeText
        ? navigator.clipboard.writeText(txt)
        : (function(){ var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return Promise.resolve(); })()
      ).then(function(){
        var old = btn.textContent; btn.textContent = '已複製';
        setTimeout(function(){ btn.textContent = old || '複製'; }, 900);
      }).catch(function(){});
    });
  }
  bindCopyDelegation();

// ---- 日期顯示：把 input 的值轉成 MM/DD 顯示在相鄰 .date-display ----
function bindShortDate(inpId, dispId){
  const inp = document.getElementById(inpId);
  const disp = document.getElementById(dispId);
  if (!inp || !disp) return;
  const sync = ()=>{
    if (inp.value) {
      const [y,m,d] = inp.value.split('-');
      disp.textContent = `${m}/${d}`;
    } else {
      disp.textContent = '—/—';
    }
  };
  inp.addEventListener('change', ()=>{ sync(); applyFilters(); });
  inp.addEventListener('input',  sync);
  sync();
}

// 初始化（放在你 loadRows() 之後或路由切到 insights 後）
bindShortDate('fltFrom','dispFrom');
bindShortDate('fltTo','dispTo');

// 快捷鍵（沿用你原本的 data-q 邏輯，記得刷新顯示）
document.querySelectorAll('.segbtn[data-q]').forEach(btn=>{
  btn.onclick = ()=>{
    const tag = btn.dataset.q;
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();

    if (tag === 'this-month'){
      const from = new Date(y, m, 1).toISOString().slice(0,10);
      const to   = new Date(y, m+1, 0).toISOString().slice(0,10);
      document.getElementById('fltFrom').value = from;
      document.getElementById('fltTo').value   = to;
    } else { // 'all'
      document.getElementById('fltFrom').value = '';
      document.getElementById('fltTo').value   = '';
    }
    // 更新顯示 + 觸發篩選
    const ev = new Event('change');
    document.getElementById('fltFrom').dispatchEvent(ev);
    document.getElementById('fltTo').dispatchEvent(ev);
  };
});

  // ===== 主題切換 =====
  const root = document.documentElement;
  const thLight = $('#thLight'), thDark = $('#thDark');
  function setTheme(mode){
    root.setAttribute('data-theme', mode === 'dark' ? 'dark' : 'light');
    localStorage.setItem('theme-mode', mode);
    [thLight, thDark].forEach(b=>b.classList.remove('active'));
    (mode === 'dark' ? thDark : thLight).classList.add('active');
  }
  setTheme(localStorage.getItem('theme-mode') || 'light');
  thLight.onclick = ()=> setTheme('light');
  thDark.onclick  = ()=> setTheme('dark');

  // ===== 右側抽屜（主選單） =====
  const sidebar = $('#sidebar');
  $('#btnMenu').addEventListener('click', ()=>{
    const open = sidebar.classList.toggle('open');
    sidebar.setAttribute('aria-hidden', open ? 'false' : 'true');
  });
  $('#sbClose').addEventListener('click', ()=>{
    sidebar.classList.remove('open');
    sidebar.setAttribute('aria-hidden','true');
  });
  $$('.sb-link').forEach(b=> b.addEventListener('click', ()=>{
    location.hash = '#' + b.dataset.nav;
    sidebar.classList.remove('open');
    sidebar.setAttribute('aria-hidden','true');
  }));

  // ===== Topbar meta：只顯示今日日期（地址移除） =====
  const meta = $('#meta');
  (function showTopDate(){
    const todayStr = new Intl.DateTimeFormat('zh-TW', {
      timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit'
    }).format(new Date());
    meta.textContent = todayStr;
  })();

  // ===== 表單（記帳） =====
  const f = $('#f'), msg = $('#msg'), submitBtn = $('#submitBtn');
  const selCat = $('#category'), selPayer = $('#payer');
  const today = new Date();
  const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);
  if (f) f.date.value = iso;
  function tip(text){ if (!msg) return; msg.textContent = text||''; if (text) setTimeout(()=> msg.textContent='', 2500); }
  function fmt(n){ return (Number(n||0)).toLocaleString(); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function loadOptions(){
    google.script.run
      .withSuccessHandler(opt=>{
        if (selCat)  fillSelect(selCat,  (opt && opt.categories) || []);
        if (selPayer)fillSelect(selPayer,(opt && opt.payers)    || []);
      })
      .withFailureHandler(err=> console.warn('readOptions fail:', err && err.message))
      .readOptions();
  }
  function fillSelect(sel, arr){
    sel.innerHTML = `<option value="" disabled selected>請選擇</option>` +
      arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  }
  loadOptions();

  if (f){
    f.addEventListener('submit', (e)=>{
      e.preventDefault();
      submitBtn.disabled = true; tip('送出中…');
      const payload = Object.fromEntries(new FormData(f).entries());
      google.script.run
        .withSuccessHandler(()=>{
          tip('已新增 ✅');
          f.reset(); f.date.value = iso;
          refreshTotals(); loadOptions();
          if (!$('#page-insights').hidden) { loadRows(); refreshCharts(); }
          submitBtn.disabled = false;
        })
        .withFailureHandler(err=>{
          tip('失敗：' + (err && err.message || err));
          submitBtn.disabled = false;
        })
        .writeEntry(payload);
    });
  }

  // KPI
  function renderKpis(d){
    $('#inkIncome').textContent  = fmt(d.totalIncome);
    $('#inkExpense').textContent = fmt(d.totalExpense);
    $('#inkBalance').textContent = fmt(d.balance);
  }
  function refreshTotals(){
    google.script.run.withSuccessHandler(renderKpis).readTotals();
  }
  $('#refreshBtn')?.addEventListener('click', ()=>{ refreshTotals(); loadOptions(); });
  refreshTotals();

  // ===== Info 頁：logo + 貸款進度 + 目前餘額 =====
  function loadInfo(){
      // 1) 讀 logo
      google.script.run.withSuccessHandler(res => {
        const img = document.getElementById('infoLogo');
        const url = (res && res.url || '').trim();
        const box = img?.closest('.logo-box');        // 你上一版有的 logo 容器（若沒用 logo-box 也沒關係）
        const infoSection = document.getElementById('page-info');
        if (!img || !url || !infoSection) return;

        img.onload = () => {
          // 設定資訊頁背景使用同一張圖片
          infoSection.style.setProperty('--hero-img', `url("${url}")`);
          // 視需要可調整整體透明度（0~1）
          infoSection.style.setProperty('--hero-overlay-alpha', '0.92');

          // 你的自適應 logo 寬高比例與兩倍尺寸設定（保持原邏輯）
          const nw = img.naturalWidth || 1;
          const nh = img.naturalHeight || 1;
          const boxEl = box || img.parentElement;
          if (boxEl){
            boxEl.style.setProperty('--logo-ar', `${nw}/${nh}`);
            boxEl.style.setProperty('--logo-w', '360px'); // 2x 尺寸
          }
          img.style.display = 'block';
        };

        img.onerror = () => {
          console.warn('logo 載入失敗：', url);
          // 背景也就不設了，保持原本底色
        };

        img.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();

         // 💡 重點：設定全屏背景用的 CSS 變數
        document.body.style.setProperty('--hero-img', `url("${url}")`);
        document.body.style.setProperty('--hero-overlay-alpha', '0.92');

      }).getLogoUrl();

      // 2) 讀貸款進度（維持原本）
      google.script.run
        .withSuccessHandler(d=>{
          const fN = n => (Number(n||0)).toLocaleString();
          document.getElementById('loanPaid').textContent  = fN(d.paid);
          document.getElementById('loanTotal').textContent = fN(d.total);
          document.getElementById('loanPct').textContent   = (d.percent ?? 0) + '%';
          document.getElementById('loanBar').style.width   =
            Math.max(0, Math.min(100, Number(d.percent || 0))) + '%';
        })
        .withFailureHandler(err=> console.warn('readLoanProgress fail:', err && err.message || err))
        .readLoanProgress();

      // 3) 目前餘額
      google.script.run
        .withSuccessHandler(t => {
          document.getElementById('loanBalance').textContent =
            (Number(t?.balance||0)).toLocaleString();
        })
        .withFailureHandler(() => {
          document.getElementById('loanBalance').textContent = '—';
        })
        .readTotals();
    }

  // ===== 分析頁 =====
  const tblBody  = $('#tbl tbody');
  const rowCount = $('#rowCount');
  const rowsMsg  = $('#rowsMsg');
  let currentRows = [];
  let filteredRows = [];
  let sortState = { key:'date', dir:'desc' };
  let chartFeatured, chartOthers;

  // ===== 程式頁（#page-code）：自訂指令 =====
  var codePageBooted = false;
  var customSeq = 0;
  function renderCustomCommands(list){
    var wrap = document.getElementById('customCmdList');
    var empty = document.getElementById('customEmpty');
    if (!wrap) return;
    wrap.innerHTML = '';
    if (!Array.isArray(list) || list.length === 0){
      if (empty) empty.hidden = false;
      return;
    }
    if (empty) empty.hidden = true;
    list.forEach(function(item){
      var id = 'cmd-custom-' + (++customSeq);
      var title = (item && item.title) ? String(item.title) : '未命名指令';
      var note  = (item && item.note)  ? String(item.note)  : '';
      var body  = (item && item.body)  ? String(item.body)  : '';
      var card = document.createElement('div');
      card.className = 'card'; card.style.margin = '0';
      card.innerHTML = ''+
        '<div class="subtitle" style="margin:0 0 6px;">'+ escapeHtml(title) +'</div>'+
        (note ? '<div style="display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:var(--muted); background:color-mix(in oklab, var(--muted) 14%, transparent);">'+ escapeHtml(note) +'</div>' : '')+
        '<pre class="codebox" style="margin-top:10px;"><code id="'+ id +'">'+ escapeHtml(body) +'</code></pre>'+
        '<button class="btn" type="button" data-copy="#'+ id +'">複製</button>';
      wrap.appendChild(card);
    });
  }

  function fetchCustomCommands(){
    if (!document.getElementById('customCmdList')) return;
    google.script.run
      .withSuccessHandler(function(res){ renderCustomCommands(res || []); })
      .withFailureHandler(function(err){ console.warn('listCommands fail:', err && err.message || err); })
      .listCommands();
  }

  function initCodePage(){
    if (codePageBooted) return;
    codePageBooted = true;
    var addBtn   = document.getElementById('btnAddCmd');
    var formWrap = document.getElementById('cmdForm');
    var tInput   = document.getElementById('cmdTitle');
    var nInput   = document.getElementById('cmdNote');
    var bInput   = document.getElementById('cmdBody');
    var okBtn    = document.getElementById('cmdSubmit');
    var cancelBtn= document.getElementById('cmdCancel');

    function openForm(){ if (formWrap) formWrap.hidden = false; }
    function closeForm(){ if (formWrap) formWrap.hidden = true; if (tInput) tInput.value=''; if (nInput) nInput.value=''; if (bInput) bInput.value=''; }

    if (addBtn)   addBtn.addEventListener('click', openForm);
    if (cancelBtn)cancelBtn.addEventListener('click', closeForm);
    if (okBtn) okBtn.addEventListener('click', function(){
      var title = (tInput && tInput.value || '').trim();
      var note  = (nInput && nInput.value || '').trim();
      var body  = (bInput && bInput.value || '').trim();
      if (!title || !body){ alert('請輸入「標題」與「指令」'); return; }
      okBtn.disabled = true;
      google.script.run
        .withSuccessHandler(function(){ okBtn.disabled = false; closeForm(); fetchCustomCommands(); })
        .withFailureHandler(function(err){ okBtn.disabled = false; alert('新增失敗：' + (err && err.message || err)); })
        .addCommand({ title: title, note: note, body: body });
    });

    fetchCustomCommands();
  }

  // 左側 sort 抽屜
  const fltToggle    = document.getElementById('fltToggle');
  const fltDrawer    = document.getElementById('fltDrawer');
  const pageInsights = document.getElementById('page-insights');

  function setDrawer(open){
    if (!fltDrawer || !fltToggle || !pageInsights) return;
    const willOpen = !!open;
    fltDrawer.classList.toggle('open', willOpen);
    fltDrawer.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
    pageInsights.classList.toggle('flt-shift', willOpen);
    fltToggle.style.left = willOpen ? `calc(var(--flt-w) + 6px)` : '6px';
    fltToggle.innerHTML  = willOpen ? '⇤' : '⇥ <small>sort</small>';
  }
  fltToggle?.addEventListener('click', ()=> setDrawer(!fltDrawer.classList.contains('open')));

  // 篩選控制（chips + segmented）
  const fltFrom   = document.getElementById('fltFrom');
  const fltTo     = document.getElementById('fltTo');
  const segType   = document.getElementById('segType');
  const chipsCat  = document.getElementById('chipsCat');
  const chipsPayer= document.getElementById('chipsPayer');

  const DEFAULT_CATS = new Set(['房貸','水電費','設備']);
  let selectedTypes  = new Set(['收入','支出']);
  let selectedCats   = new Set(DEFAULT_CATS);
  let selectedPayers = new Set();

  function makeChip(text, on){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'chip' + (on ? ' active' : '');
    b.textContent = text;
    b.dataset.val = text;
    b.addEventListener('click', ()=>{ b.classList.toggle('active'); applyFilters(); });
    return b;
  }

  function buildChipsFromData(rows){
    const cats   = Array.from(new Set(rows.map(r=> r.category || '（未分類）'))).sort();
    const payers = Array.from(new Set(rows.map(r=> r.payer    || '（未填）'))).sort();

    chipsCat.innerHTML = '';
    selectedCats = new Set();
    cats.forEach(c=>{
      const on = DEFAULT_CATS.has(c);
      if (on) selectedCats.add(c);
      chipsCat.appendChild(makeChip(c, on));
    });

    chipsPayer.innerHTML = '';
    selectedPayers = new Set(payers);
    payers.forEach(p=> chipsPayer.appendChild(makeChip(p, true)));

    // 收入/支出（可複選）
    segType.querySelectorAll('.segbtn').forEach(btn=>{
      btn.onclick = ()=>{
        const v = btn.dataset.type;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) selectedTypes.add(v);
        else selectedTypes.delete(v);
        if (selectedTypes.size === 0){ selectedTypes.add(v); btn.classList.add('active'); }
        applyFilters();
      };
    });

    fltFrom.onchange = applyFilters;
    fltTo.onchange   = applyFilters;

  }

  function loadRows(){
    if (!tblBody) return;
    rowsMsg.textContent = '載入中…';
    google.script.run
      .withSuccessHandler(res=>{
        const raw = Array.isArray(res?.rows) ? res.rows : [];
        currentRows = raw.map(r=>{
          const amt = Number(String(r.amount||'').replace(/,/g,'').trim()) || 0;
          let d = null;
          if (r.dateStr){
            const m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            d = m ? new Date(+m[1], +m[2]-1, +m[3]) : new Date(r.dateStr);
          }
          if (!(d instanceof Date) || isNaN(d)) d = new Date(0);
          return { ...r, amount: amt, date: d };
        });

        buildChipsFromData(currentRows);
        fltFrom.value = ''; fltTo.value = '';   // 預設「全部」
        setDrawer(false);                       // 預設收合
        applyFilters();
        rowsMsg.textContent = '';
      })
      .withFailureHandler(err=>{
        rowsMsg.textContent = '讀取失敗：' + (err?.message || err);
        console.error('readRowsLatest fail:', err);
      })
      .readRowsLatest(1000);
  }

  function renderTable(rowsIn){
    const rows = [...(rowsIn||[])].sort((a,b)=>{
      const k = sortState.key, dir = sortState.dir === 'asc' ? 1 : -1;
      let va = a[k], vb = b[k];
      if (k === 'amount') { va = Number(va||0); vb = Number(vb||0); }
      if (k === 'date' || k === 'dateStr') {
        va = new Date(a.dateStr || a.date); vb = new Date(b.dateStr || b.date);
      }
      if (va < vb) return -1 * dir;
      if (va > vb) return  1 * dir;
      return 0;
    });
    tblBody.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.dateStr || '')}</td>
        <td>${escapeHtml(r.title || '')}</td>
        <td>${escapeHtml(r.category || '')}</td>
        <td class="t-right">${(Number(r.amount||0)).toLocaleString()}</td>
        <td>${escapeHtml(r.type || '')}</td>
        <td>${escapeHtml(r.payer || '')}</td>
      </tr>
    `).join('');
  }
  $$('#tbl thead th').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.k; if (!k) return;
      if (sortState.key === k) sortState.dir = (sortState.dir === 'asc' ? 'desc' : 'asc');
      else { sortState.key = k; sortState.dir = 'asc'; }
      renderTable(filteredRows);
    });
  });

  function drawChartsFromRows(rows){
    // 左圖：分類長條（含數值標籤）
    const byCat = {};
    rows.forEach(r=>{
      const c = (r.category || '（未分類）').trim();
      if (!byCat[c]) byCat[c] = { inc:0, exp:0, tot:0 };
      const n = Number(r.amount||0) || 0;
      if (r.type === '收入') byCat[c].inc += n; else byCat[c].exp += n;
      byCat[c].tot += n;
    });
    const catSorted = Object.entries(byCat).sort((a,b)=> b[1].tot - a[1].tot);
    const L = { labels: catSorted.map(([k])=>k),
                inc:    catSorted.map(([,v])=>v.inc),
                exp:    catSorted.map(([,v])=>v.exp) };

    // 右圖：時間軸「累積」折線（類別軸避免 adapter 需求）
    const daily = new Map(); // yyyy-MM-dd -> {inc,exp}
    const toDate = r=>{
      if (r.dateStr){
        const m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
        return m ? new Date(Number(m[1]), Number(m[2])-1, Number(m[3])) : new Date(r.dateStr);
      }
      return r.date ? new Date(r.date) : new Date(0);
    };
    [...rows].sort((a,b)=> toDate(a) - toDate(b)).forEach(r=>{
      const d = toDate(r); if (!(d instanceof Date) || isNaN(d)) return;
      const k = d.toISOString().slice(0,10);
      if (!daily.has(k)) daily.set(k,{inc:0,exp:0});
      const v = daily.get(k), n = Number(r.amount||0) || 0;
      if (r.type === '收入') v.inc += n; else v.exp += n;
    });
    const labelsT = Array.from(daily.keys()).sort();
    let accInc = 0, accExp = 0;
    const seriesInc = [], seriesExp = [];
    labelsT.forEach(k=>{ const v = daily.get(k); accInc += v.inc; accExp += v.exp; seriesInc.push(accInc); seriesExp.push(accExp); });

    // 重畫
    if (chartFeatured) chartFeatured.destroy();
    if (chartOthers)   chartOthers.destroy();

    // 柱頂數值標籤
    const valueLabelPlugin = {
      id: 'valueLabel',
      afterDatasetsDraw(chart){
        const {ctx} = chart;
        ctx.save();
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans"';
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg') || '#111';
        chart.data.datasets.forEach((dset, di)=>{
          const meta = chart.getDatasetMeta(di);
          if (meta.type !== 'bar') return;
          meta.data.forEach((bar, i)=>{
            const val = dset.data[i]; if (val == null) return;
            const p = bar.tooltipPosition();
            ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
            ctx.fillText(Number(val).toLocaleString(), p.x, p.y - 4);
          });
        });
        ctx.restore();
      }
    };

    chartFeatured = new Chart(document.getElementById('chartFeatured').getContext('2d'), {
      type: 'bar',
      data: { labels: L.labels, datasets: [
        { label:'收入', data: L.inc,  borderWidth:1 },
        { label:'支出', data: L.exp,  borderWidth:1 }
      ]},
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'top' } } },
      plugins: [valueLabelPlugin]
    });

    const typesNow = new Set(Array.from(document.querySelectorAll('#segType .segbtn.active')).map(b=>b.dataset.type));
    const datasetsT = [];
    if (typesNow.has('收入')) datasetsT.push({ label:'收入(累積)', data: seriesInc, borderWidth:2, type:'line' });
    if (typesNow.has('支出')) datasetsT.push({ label:'支出(累積)', data: seriesExp, borderWidth:2, type:'line' });

    chartOthers = new Chart(document.getElementById('chartOthers').getContext('2d'), {
      type: 'line',
      data: { labels: labelsT, datasets: datasetsT },
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }, x:{ type:'category' } }, plugins:{ legend:{ position:'top' } } }
    });
  }

  function refreshCharts(){ drawChartsFromRows(filteredRows.length ? filteredRows : currentRows); }

  function applyFilters(){
    const getAct = sel => Array.from(sel.querySelectorAll('.active')).map(b=> b.dataset.val || b.dataset.type);
    const cats   = new Set(getAct(chipsCat));
    const pays   = new Set(getAct(chipsPayer));
    const types  = new Set(getAct(segType));
    const from = fltFrom.value ? new Date(fltFrom.value + 'T00:00:00') : null;
    const to   = fltTo.value   ? new Date(fltTo.value   + 'T23:59:59') : null;

    filteredRows = currentRows.filter(r=>{
      const d = r.dateStr ? new Date(r.dateStr.replace(/\./g,'/')) : (r.date ? new Date(r.date) : null);
      if (from && d && d < from) return false;
      if (to   && d && d > to)   return false;
      const c = r.category || '（未分類）';
      const p = r.payer    || '（未填）';
      const t = r.type     || '';
      if (cats.size  && !cats.has(c))  return false;
      if (pays.size  && !pays.has(p))  return false;
      if (types.size && !types.has(t)) return false;
      return true;
    });

    rowCount.textContent = String(filteredRows.length);
    renderTable(filteredRows);
    refreshCharts();

    renderSumBar();
  }

  // ===== 圖表收合/展開 =====
  const chartsBox   = document.getElementById('chartsBox');
  const chartPh     = document.getElementById('chartPlaceholder');
  const btnChartTgl = document.getElementById('btnChartToggle');

  function setChartsCollapsed(on){
    chartsBox.classList.toggle('collapsed', !!on);
    btnChartTgl.textContent = on ? '展開圖表' : '收合圖表';
    setTimeout(()=>{ chartFeatured?.resize(); chartOthers?.resize(); }, 0);
  }
  btnChartTgl?.addEventListener('click', ()=>{
    const on = !chartsBox.classList.contains('collapsed');
    setChartsCollapsed(on);
  });
  chartPh?.addEventListener('click', ()=> setChartsCollapsed(false));

  // ===== 路由 + 分頁名稱 =====
  const pageNameEl = document.getElementById('pageName');
  const pageNames  = { info:'資訊', home:'記帳', insights:'分析', code:'程式' };

  function showPage(name){
    $('#page-info').hidden     = (name !== 'info');
    $('#page-home').hidden     = (name !== 'home');
    $('#page-insights').hidden = (name !== 'insights');
    $('#page-code').hidden     = (name !== 'code');
    $$('.sb-link').forEach(b=> b.classList.toggle('active', b.dataset.nav === name));
    pageNameEl.textContent = pageNames[name] || '';
    if (name === 'insights') { setDrawer(false); loadRows(); }
    if (name === 'info')     { loadInfo(); }
    if (name === 'code')     { initCodePage(); }
  }
  function applyHash(){
    const h = (location.hash || '#info').replace('#','');
    showPage(['info','home','insights','code'].includes(h) ? h : 'info');
  }
  window.addEventListener('hashchange', applyHash);
  applyHash();

/* === 分析頁：加總列 ===
   - 顯示目前「類別」的選取（= 左抽屜 chips 的 active）
   - 右側顯示金額合計（在 filteredRows 基礎上再依類別聚合）
   - 點氣泡 → 取消該類別（等同取消左抽屜 chip）並重算
*/
function renderSumBar(){
  const sumTagsBox = document.getElementById('sumTags');
  const sumTotalEl = document.getElementById('sumTotal');
  if (!sumTagsBox || !sumTotalEl) return;

  // 目前「有被選中」的類別（= 左抽屜 chips.active）
  const activeCats = Array.from(document.querySelectorAll('#chipsCat .chip.active'))
    .map(b => b.dataset.val);

  // 如果沒有任何類別被選中，語意上＝全部類別
  const usingAll = activeCats.length === 0;

  // 準備要顯示在左邊的小氣泡們
  sumTagsBox.innerHTML = '';
  if (usingAll){
    const tag = document.createElement('span');
    tag.className = 'sum-tag is-all';
    tag.textContent = '全部類別';
    sumTagsBox.appendChild(tag);
  } else {
    activeCats.forEach(cat=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'sum-tag';
      btn.innerHTML = `<span>${cat}</span><span class="x">×</span>`;
      btn.addEventListener('click', ()=>{
        // 取消左抽屜對應 chip 的 active
        const chip = Array.from(document.querySelectorAll('#chipsCat .chip'))
          .find(c => c.dataset.val === cat);
        if (chip){ chip.classList.remove('active'); }
        applyFilters(); // 會順便重畫表格/圖表/加總列
      });
      sumTagsBox.appendChild(btn);
    });
  }

  // 計算加總：在「已套用其他條件」的 filteredRows 裡再根據 activeCats 合計
  let total = 0;
  // 當使用「全部」時，容許所有類別；否則只算 activeCats 內的
  const allowSet = usingAll
    ? null
    : new Set(activeCats);

  filteredRows.forEach(r=>{
    const cat = (r.category || '（未分類）').trim();
    if (allowSet && !allowSet.has(cat)) return;
    // 這裡以「金額相加」為準（不論收入/支出）
    // 若你要把支出視為負數，改成：const val = (r.type === '支出' ? -1 : 1) * Number(r.amount||0)
    const val = Number(r.amount || 0);
    total += val;
  });

  sumTotalEl.textContent = total.toLocaleString();
}
  
})();
</script>