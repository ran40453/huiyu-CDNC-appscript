<script>

(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // ---- é€šç”¨ï¼šé»æ“Š data-copy è¤‡è£½æŒ‡å®šç¯€é»çš„æ–‡å­— ----
  function bindCopyDelegation(){
    document.addEventListener('click', function(e){
      var btn = e.target.closest('[data-copy]');
      if (!btn) return;
      var sel = btn.getAttribute('data-copy');
      var el  = sel ? document.querySelector(sel) : null;
      if (!el) return;
      var txt = (el.textContent || '').trim();
      if (!txt) return;
      (navigator.clipboard && navigator.clipboard.writeText
        ? navigator.clipboard.writeText(txt)
        : (function(){ var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return Promise.resolve(); })()
      ).then(function(){
        var old = btn.textContent; btn.textContent = 'å·²è¤‡è£½';
        setTimeout(function(){ btn.textContent = old || 'è¤‡è£½'; }, 900);
      }).catch(function(){});
    });
  }
  bindCopyDelegation();

// ---- æ—¥æœŸé¡¯ç¤ºï¼šæŠŠ input çš„å€¼è½‰æˆ MM/DD é¡¯ç¤ºåœ¨ç›¸é„° .date-display ----
function bindShortDate(inpId, dispId){
  const inp = document.getElementById(inpId);
  const disp = document.getElementById(dispId);
  if (!inp || !disp) return;
  const sync = ()=>{
    if (inp.value) {
      const [y,m,d] = inp.value.split('-');
      disp.textContent = `${m}/${d}`;
    } else {
      disp.textContent = 'â€”/â€”';
    }
  };
  inp.addEventListener('change', ()=>{ sync(); applyFilters(); });
  inp.addEventListener('input',  sync);
  sync();
}

// åˆå§‹åŒ–ï¼ˆæ”¾åœ¨ä½  loadRows() ä¹‹å¾Œæˆ–è·¯ç”±åˆ‡åˆ° insights å¾Œï¼‰
bindShortDate('fltFrom','dispFrom');
bindShortDate('fltTo','dispTo');

// å¿«æ·éµï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„ data-q é‚è¼¯ï¼Œè¨˜å¾—åˆ·æ–°é¡¯ç¤ºï¼‰
document.querySelectorAll('.segbtn[data-q]').forEach(btn=>{
  btn.onclick = ()=>{
    const tag = btn.dataset.q;
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();

    if (tag === 'this-month'){
      const from = new Date(y, m, 1).toISOString().slice(0,10);
      const to   = new Date(y, m+1, 0).toISOString().slice(0,10);
      document.getElementById('fltFrom').value = from;
      document.getElementById('fltTo').value   = to;
    } else { // 'all'
      document.getElementById('fltFrom').value = '';
      document.getElementById('fltTo').value   = '';
    }
    // æ›´æ–°é¡¯ç¤º + è§¸ç™¼ç¯©é¸
    const ev = new Event('change');
    document.getElementById('fltFrom').dispatchEvent(ev);
    document.getElementById('fltTo').dispatchEvent(ev);
  };
});

  // ===== ä¸»é¡Œåˆ‡æ› =====
  const root = document.documentElement;
  const thLight = $('#thLight'), thDark = $('#thDark');
  function setTheme(mode){
    root.setAttribute('data-theme', mode === 'dark' ? 'dark' : 'light');
    localStorage.setItem('theme-mode', mode);
    [thLight, thDark].forEach(b=>b.classList.remove('active'));
    (mode === 'dark' ? thDark : thLight).classList.add('active');
  }
  setTheme(localStorage.getItem('theme-mode') || 'light');
  thLight.onclick = ()=> setTheme('light');
  thDark.onclick  = ()=> setTheme('dark');

  // ===== å³å´æŠ½å±œï¼ˆä¸»é¸å–®ï¼‰ =====
  const sidebar = $('#sidebar');
  $('#btnMenu').addEventListener('click', ()=>{
    const open = sidebar.classList.toggle('open');
    sidebar.setAttribute('aria-hidden', open ? 'false' : 'true');
  });
  $('#sbClose').addEventListener('click', ()=>{
    sidebar.classList.remove('open');
    sidebar.setAttribute('aria-hidden','true');
  });
  $$('.sb-link').forEach(b=> b.addEventListener('click', ()=>{
    location.hash = '#' + b.dataset.nav;
    sidebar.classList.remove('open');
    sidebar.setAttribute('aria-hidden','true');
  }));

  // ===== Topbar metaï¼šåªé¡¯ç¤ºä»Šæ—¥æ—¥æœŸï¼ˆåœ°å€ç§»é™¤ï¼‰ =====
  const meta = $('#meta');
  (function showTopDate(){
    const todayStr = new Intl.DateTimeFormat('zh-TW', {
      timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit'
    }).format(new Date());
    meta.textContent = todayStr;
  })();

  // ===== è¡¨å–®ï¼ˆè¨˜å¸³ï¼‰ =====
  const f = $('#f'), msg = $('#msg'), submitBtn = $('#submitBtn');
  const selCat = $('#category'), selPayer = $('#payer');
  const today = new Date();
  const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);
  if (f) f.date.value = iso;
  function tip(text){ if (!msg) return; msg.textContent = text||''; if (text) setTimeout(()=> msg.textContent='', 2500); }
  function fmt(n){ return (Number(n||0)).toLocaleString(); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function loadOptions(){
    google.script.run
      .withSuccessHandler(opt=>{
        if (selCat)  fillSelect(selCat,  (opt && opt.categories) || []);
        if (selPayer)fillSelect(selPayer,(opt && opt.payers)    || []);
      })
      .withFailureHandler(err=> console.warn('readOptions fail:', err && err.message))
      .readOptions();
  }
  function fillSelect(sel, arr){
    sel.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡</option>` +
      arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
  }
  loadOptions();

  if (f){
    f.addEventListener('submit', (e)=>{
      e.preventDefault();
      submitBtn.disabled = true; tip('é€å‡ºä¸­â€¦');
      const payload = Object.fromEntries(new FormData(f).entries());
      google.script.run
        .withSuccessHandler(()=>{
          tip('å·²æ–°å¢ âœ…');
          f.reset(); f.date.value = iso;
          refreshTotals(); loadOptions();
          if (!$('#page-insights').hidden) { loadRows(); refreshCharts(); }
          submitBtn.disabled = false;
        })
        .withFailureHandler(err=>{
          tip('å¤±æ•—ï¼š' + (err && err.message || err));
          submitBtn.disabled = false;
        })
        .writeEntry(payload);
    });
  }

  // KPI
  function renderKpis(d){
    $('#inkIncome').textContent  = fmt(d.totalIncome);
    $('#inkExpense').textContent = fmt(d.totalExpense);
    $('#inkBalance').textContent = fmt(d.balance);
  }
  function refreshTotals(){
    google.script.run.withSuccessHandler(renderKpis).readTotals();
  }
  $('#refreshBtn')?.addEventListener('click', ()=>{ refreshTotals(); loadOptions(); });
  refreshTotals();

  // ===== Info é ï¼šlogo + è²¸æ¬¾é€²åº¦ + ç›®å‰é¤˜é¡ =====
  function loadInfo(){
      // 1) è®€ logo
      google.script.run.withSuccessHandler(res => {
        const img = document.getElementById('infoLogo');
        const url = (res && res.url || '').trim();
        const box = img?.closest('.logo-box');        // ä½ ä¸Šä¸€ç‰ˆæœ‰çš„ logo å®¹å™¨ï¼ˆè‹¥æ²’ç”¨ logo-box ä¹Ÿæ²’é—œä¿‚ï¼‰
        const infoSection = document.getElementById('page-info');
        if (!img || !url || !infoSection) return;

        img.onload = () => {
          // è¨­å®šè³‡è¨Šé èƒŒæ™¯ä½¿ç”¨åŒä¸€å¼µåœ–ç‰‡
          infoSection.style.setProperty('--hero-img', `url("${url}")`);
          // è¦–éœ€è¦å¯èª¿æ•´æ•´é«”é€æ˜åº¦ï¼ˆ0~1ï¼‰
          infoSection.style.setProperty('--hero-overlay-alpha', '0.92');

          // ä½ çš„è‡ªé©æ‡‰ logo å¯¬é«˜æ¯”ä¾‹èˆ‡å…©å€å°ºå¯¸è¨­å®šï¼ˆä¿æŒåŸé‚è¼¯ï¼‰
          const nw = img.naturalWidth || 1;
          const nh = img.naturalHeight || 1;
          const boxEl = box || img.parentElement;
          if (boxEl){
            boxEl.style.setProperty('--logo-ar', `${nw}/${nh}`);
            boxEl.style.setProperty('--logo-w', '360px'); // 2x å°ºå¯¸
          }
          img.style.display = 'block';
        };

        img.onerror = () => {
          console.warn('logo è¼‰å…¥å¤±æ•—ï¼š', url);
          // èƒŒæ™¯ä¹Ÿå°±ä¸è¨­äº†ï¼Œä¿æŒåŸæœ¬åº•è‰²
        };

        img.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();

         // ğŸ’¡ é‡é»ï¼šè¨­å®šå…¨å±èƒŒæ™¯ç”¨çš„ CSS è®Šæ•¸
        document.body.style.setProperty('--hero-img', `url("${url}")`);
        document.body.style.setProperty('--hero-overlay-alpha', '0.92');

      }).getLogoUrl();

      // 2) è®€è²¸æ¬¾é€²åº¦ï¼ˆç¶­æŒåŸæœ¬ï¼‰
      google.script.run
        .withSuccessHandler(d=>{
          const fN = n => (Number(n||0)).toLocaleString();
          document.getElementById('loanPaid').textContent  = fN(d.paid);
          document.getElementById('loanTotal').textContent = fN(d.total);
          document.getElementById('loanPct').textContent   = (d.percent ?? 0) + '%';
          document.getElementById('loanBar').style.width   =
            Math.max(0, Math.min(100, Number(d.percent || 0))) + '%';
        })
        .withFailureHandler(err=> console.warn('readLoanProgress fail:', err && err.message || err))
        .readLoanProgress();

      // 3) ç›®å‰é¤˜é¡
      google.script.run
        .withSuccessHandler(t => {
          document.getElementById('loanBalance').textContent =
            (Number(t?.balance||0)).toLocaleString();
        })
        .withFailureHandler(() => {
          document.getElementById('loanBalance').textContent = 'â€”';
        })
        .readTotals();
    }

  // ===== åˆ†æé  =====
  const tblBody  = $('#tbl tbody');
  const rowCount = $('#rowCount');
  const rowsMsg  = $('#rowsMsg');
  let currentRows = [];
  let filteredRows = [];
  let sortState = { key:'date', dir:'desc' };
  let chartFeatured, chartOthers;

  // ===== ç¨‹å¼é ï¼ˆ#page-codeï¼‰ï¼šè‡ªè¨‚æŒ‡ä»¤ =====
  var codePageBooted = false;
  var customSeq = 0;
  function renderCustomCommands(list){
    var wrap = document.getElementById('customCmdList');
    var empty = document.getElementById('customEmpty');
    if (!wrap) return;
    wrap.innerHTML = '';
    if (!Array.isArray(list) || list.length === 0){
      if (empty) empty.hidden = false;
      return;
    }
    if (empty) empty.hidden = true;
    list.forEach(function(item){
      var id = 'cmd-custom-' + (++customSeq);
      var title = (item && item.title) ? String(item.title) : 'æœªå‘½åæŒ‡ä»¤';
      var note  = (item && item.note)  ? String(item.note)  : '';
      var body  = (item && item.body)  ? String(item.body)  : '';
      var card = document.createElement('div');
      card.className = 'card'; card.style.margin = '0';
      card.innerHTML = ''+
        '<div class="subtitle" style="margin:0 0 6px;">'+ escapeHtml(title) +'</div>'+
        (note ? '<div style="display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:var(--muted); background:color-mix(in oklab, var(--muted) 14%, transparent);">'+ escapeHtml(note) +'</div>' : '')+
        '<pre class="codebox" style="margin-top:10px;"><code id="'+ id +'">'+ escapeHtml(body) +'</code></pre>'+
        '<button class="btn" type="button" data-copy="#'+ id +'">è¤‡è£½</button>';
      wrap.appendChild(card);
    });
  }

  function fetchCustomCommands(){
    if (!document.getElementById('customCmdList')) return;
    google.script.run
      .withSuccessHandler(function(res){ renderCustomCommands(res || []); })
      .withFailureHandler(function(err){ console.warn('listCommands fail:', err && err.message || err); })
      .listCommands();
  }

  function initCodePage(){
    if (codePageBooted) return;
    codePageBooted = true;
    var addBtn   = document.getElementById('btnAddCmd');
    var formWrap = document.getElementById('cmdForm');
    var tInput   = document.getElementById('cmdTitle');
    var nInput   = document.getElementById('cmdNote');
    var bInput   = document.getElementById('cmdBody');
    var okBtn    = document.getElementById('cmdSubmit');
    var cancelBtn= document.getElementById('cmdCancel');

    function openForm(){ if (formWrap) formWrap.hidden = false; }
    function closeForm(){ if (formWrap) formWrap.hidden = true; if (tInput) tInput.value=''; if (nInput) nInput.value=''; if (bInput) bInput.value=''; }

    if (addBtn)   addBtn.addEventListener('click', openForm);
    if (cancelBtn)cancelBtn.addEventListener('click', closeForm);
    if (okBtn) okBtn.addEventListener('click', function(){
      var title = (tInput && tInput.value || '').trim();
      var note  = (nInput && nInput.value || '').trim();
      var body  = (bInput && bInput.value || '').trim();
      if (!title || !body){ alert('è«‹è¼¸å…¥ã€Œæ¨™é¡Œã€èˆ‡ã€ŒæŒ‡ä»¤ã€'); return; }
      okBtn.disabled = true;
      google.script.run
        .withSuccessHandler(function(){ okBtn.disabled = false; closeForm(); fetchCustomCommands(); })
        .withFailureHandler(function(err){ okBtn.disabled = false; alert('æ–°å¢å¤±æ•—ï¼š' + (err && err.message || err)); })
        .addCommand({ title: title, note: note, body: body });
    });

    fetchCustomCommands();
  }

  // å·¦å´ sort æŠ½å±œ
  const fltToggle    = document.getElementById('fltToggle');
  const fltDrawer    = document.getElementById('fltDrawer');
  const pageInsights = document.getElementById('page-insights');

  function setDrawer(open){
    if (!fltDrawer || !fltToggle || !pageInsights) return;
    const willOpen = !!open;
    fltDrawer.classList.toggle('open', willOpen);
    fltDrawer.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
    pageInsights.classList.toggle('flt-shift', willOpen);
    fltToggle.style.left = willOpen ? `calc(var(--flt-w) + 6px)` : '6px';
    fltToggle.innerHTML  = willOpen ? 'â‡¤' : 'â‡¥ <small>sort</small>';
  }
  fltToggle?.addEventListener('click', ()=> setDrawer(!fltDrawer.classList.contains('open')));

  // ç¯©é¸æ§åˆ¶ï¼ˆchips + segmentedï¼‰
  const fltFrom   = document.getElementById('fltFrom');
  const fltTo     = document.getElementById('fltTo');
  const segType   = document.getElementById('segType');
  const chipsCat  = document.getElementById('chipsCat');
  const chipsPayer= document.getElementById('chipsPayer');

  const DEFAULT_CATS = new Set(['æˆ¿è²¸','æ°´é›»è²»','è¨­å‚™']);
  let selectedTypes  = new Set(['æ”¶å…¥','æ”¯å‡º']);
  let selectedCats   = new Set(DEFAULT_CATS);
  let selectedPayers = new Set();

  function makeChip(text, on){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'chip' + (on ? ' active' : '');
    b.textContent = text;
    b.dataset.val = text;
    b.addEventListener('click', ()=>{ b.classList.toggle('active'); applyFilters(); });
    return b;
  }

  function buildChipsFromData(rows){
    const cats   = Array.from(new Set(rows.map(r=> r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰'))).sort();
    const payers = Array.from(new Set(rows.map(r=> r.payer    || 'ï¼ˆæœªå¡«ï¼‰'))).sort();

    chipsCat.innerHTML = '';
    selectedCats = new Set();
    cats.forEach(c=>{
      const on = DEFAULT_CATS.has(c);
      if (on) selectedCats.add(c);
      chipsCat.appendChild(makeChip(c, on));
    });

    chipsPayer.innerHTML = '';
    selectedPayers = new Set(payers);
    payers.forEach(p=> chipsPayer.appendChild(makeChip(p, true)));

    // æ”¶å…¥/æ”¯å‡ºï¼ˆå¯è¤‡é¸ï¼‰
    segType.querySelectorAll('.segbtn').forEach(btn=>{
      btn.onclick = ()=>{
        const v = btn.dataset.type;
        btn.classList.toggle('active');
        if (btn.classList.contains('active')) selectedTypes.add(v);
        else selectedTypes.delete(v);
        if (selectedTypes.size === 0){ selectedTypes.add(v); btn.classList.add('active'); }
        applyFilters();
      };
    });

    fltFrom.onchange = applyFilters;
    fltTo.onchange   = applyFilters;

  }

  function loadRows(){
    if (!tblBody) return;
    rowsMsg.textContent = 'è¼‰å…¥ä¸­â€¦';
    google.script.run
      .withSuccessHandler(res=>{
        const raw = Array.isArray(res?.rows) ? res.rows : [];
        currentRows = raw.map(r=>{
          const amt = Number(String(r.amount||'').replace(/,/g,'').trim()) || 0;
          let d = null;
          if (r.dateStr){
            const m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            d = m ? new Date(+m[1], +m[2]-1, +m[3]) : new Date(r.dateStr);
          }
          if (!(d instanceof Date) || isNaN(d)) d = new Date(0);
          return { ...r, amount: amt, date: d };
        });

        buildChipsFromData(currentRows);
        fltFrom.value = ''; fltTo.value = '';   // é è¨­ã€Œå…¨éƒ¨ã€
        setDrawer(false);                       // é è¨­æ”¶åˆ
        applyFilters();
        rowsMsg.textContent = '';
      })
      .withFailureHandler(err=>{
        rowsMsg.textContent = 'è®€å–å¤±æ•—ï¼š' + (err?.message || err);
        console.error('readRowsLatest fail:', err);
      })
      .readRowsLatest(1000);
  }

  function renderTable(rowsIn){
    const rows = [...(rowsIn||[])].sort((a,b)=>{
      const k = sortState.key, dir = sortState.dir === 'asc' ? 1 : -1;
      let va = a[k], vb = b[k];
      if (k === 'amount') { va = Number(va||0); vb = Number(vb||0); }
      if (k === 'date' || k === 'dateStr') {
        va = new Date(a.dateStr || a.date); vb = new Date(b.dateStr || b.date);
      }
      if (va < vb) return -1 * dir;
      if (va > vb) return  1 * dir;
      return 0;
    });
    tblBody.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.dateStr || '')}</td>
        <td>${escapeHtml(r.title || '')}</td>
        <td>${escapeHtml(r.category || '')}</td>
        <td class="t-right">${(Number(r.amount||0)).toLocaleString()}</td>
        <td>${escapeHtml(r.type || '')}</td>
        <td>${escapeHtml(r.payer || '')}</td>
      </tr>
    `).join('');
  }
  $$('#tbl thead th').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.k; if (!k) return;
      if (sortState.key === k) sortState.dir = (sortState.dir === 'asc' ? 'desc' : 'asc');
      else { sortState.key = k; sortState.dir = 'asc'; }
      renderTable(filteredRows);
    });
  });

  function drawChartsFromRows(rows){
    // å·¦åœ–ï¼šåˆ†é¡é•·æ¢ï¼ˆå«æ•¸å€¼æ¨™ç±¤ï¼‰
    const byCat = {};
    rows.forEach(r=>{
      const c = (r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰').trim();
      if (!byCat[c]) byCat[c] = { inc:0, exp:0, tot:0 };
      const n = Number(r.amount||0) || 0;
      if (r.type === 'æ”¶å…¥') byCat[c].inc += n; else byCat[c].exp += n;
      byCat[c].tot += n;
    });
    const catSorted = Object.entries(byCat).sort((a,b)=> b[1].tot - a[1].tot);
    const L = { labels: catSorted.map(([k])=>k),
                inc:    catSorted.map(([,v])=>v.inc),
                exp:    catSorted.map(([,v])=>v.exp) };

    // å³åœ–ï¼šæ™‚é–“è»¸ã€Œç´¯ç©ã€æŠ˜ç·šï¼ˆé¡åˆ¥è»¸é¿å… adapter éœ€æ±‚ï¼‰
    const daily = new Map(); // yyyy-MM-dd -> {inc,exp}
    const toDate = r=>{
      if (r.dateStr){
        const m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
        return m ? new Date(Number(m[1]), Number(m[2])-1, Number(m[3])) : new Date(r.dateStr);
      }
      return r.date ? new Date(r.date) : new Date(0);
    };
    [...rows].sort((a,b)=> toDate(a) - toDate(b)).forEach(r=>{
      const d = toDate(r); if (!(d instanceof Date) || isNaN(d)) return;
      const k = d.toISOString().slice(0,10);
      if (!daily.has(k)) daily.set(k,{inc:0,exp:0});
      const v = daily.get(k), n = Number(r.amount||0) || 0;
      if (r.type === 'æ”¶å…¥') v.inc += n; else v.exp += n;
    });
    const labelsT = Array.from(daily.keys()).sort();
    let accInc = 0, accExp = 0;
    const seriesInc = [], seriesExp = [];
    labelsT.forEach(k=>{ const v = daily.get(k); accInc += v.inc; accExp += v.exp; seriesInc.push(accInc); seriesExp.push(accExp); });

    // é‡ç•«
    if (chartFeatured) chartFeatured.destroy();
    if (chartOthers)   chartOthers.destroy();

    // æŸ±é ‚æ•¸å€¼æ¨™ç±¤
    const valueLabelPlugin = {
      id: 'valueLabel',
      afterDatasetsDraw(chart){
        const {ctx} = chart;
        ctx.save();
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans"';
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg') || '#111';
        chart.data.datasets.forEach((dset, di)=>{
          const meta = chart.getDatasetMeta(di);
          if (meta.type !== 'bar') return;
          meta.data.forEach((bar, i)=>{
            const val = dset.data[i]; if (val == null) return;
            const p = bar.tooltipPosition();
            ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
            ctx.fillText(Number(val).toLocaleString(), p.x, p.y - 4);
          });
        });
        ctx.restore();
      }
    };

    chartFeatured = new Chart(document.getElementById('chartFeatured').getContext('2d'), {
      type: 'bar',
      data: { labels: L.labels, datasets: [
        { label:'æ”¶å…¥', data: L.inc,  borderWidth:1 },
        { label:'æ”¯å‡º', data: L.exp,  borderWidth:1 }
      ]},
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'top' } } },
      plugins: [valueLabelPlugin]
    });

    const typesNow = new Set(Array.from(document.querySelectorAll('#segType .segbtn.active')).map(b=>b.dataset.type));
    const datasetsT = [];
    if (typesNow.has('æ”¶å…¥')) datasetsT.push({ label:'æ”¶å…¥(ç´¯ç©)', data: seriesInc, borderWidth:2, type:'line' });
    if (typesNow.has('æ”¯å‡º')) datasetsT.push({ label:'æ”¯å‡º(ç´¯ç©)', data: seriesExp, borderWidth:2, type:'line' });

    chartOthers = new Chart(document.getElementById('chartOthers').getContext('2d'), {
      type: 'line',
      data: { labels: labelsT, datasets: datasetsT },
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }, x:{ type:'category' } }, plugins:{ legend:{ position:'top' } } }
    });
  }

  function refreshCharts(){ drawChartsFromRows(filteredRows.length ? filteredRows : currentRows); }

  function applyFilters(){
    const getAct = sel => Array.from(sel.querySelectorAll('.active')).map(b=> b.dataset.val || b.dataset.type);
    const cats   = new Set(getAct(chipsCat));
    const pays   = new Set(getAct(chipsPayer));
    const types  = new Set(getAct(segType));
    const from = fltFrom.value ? new Date(fltFrom.value + 'T00:00:00') : null;
    const to   = fltTo.value   ? new Date(fltTo.value   + 'T23:59:59') : null;

    filteredRows = currentRows.filter(r=>{
      const d = r.dateStr ? new Date(r.dateStr.replace(/\./g,'/')) : (r.date ? new Date(r.date) : null);
      if (from && d && d < from) return false;
      if (to   && d && d > to)   return false;
      const c = r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰';
      const p = r.payer    || 'ï¼ˆæœªå¡«ï¼‰';
      const t = r.type     || '';
      if (cats.size  && !cats.has(c))  return false;
      if (pays.size  && !pays.has(p))  return false;
      if (types.size && !types.has(t)) return false;
      return true;
    });

    rowCount.textContent = String(filteredRows.length);
    renderTable(filteredRows);
    refreshCharts();

    renderSumBar();
  }

  // ===== åœ–è¡¨æ”¶åˆ/å±•é–‹ =====
  const chartsBox   = document.getElementById('chartsBox');
  const chartPh     = document.getElementById('chartPlaceholder');
  const btnChartTgl = document.getElementById('btnChartToggle');

  function setChartsCollapsed(on){
    chartsBox.classList.toggle('collapsed', !!on);
    btnChartTgl.textContent = on ? 'å±•é–‹åœ–è¡¨' : 'æ”¶åˆåœ–è¡¨';
    setTimeout(()=>{ chartFeatured?.resize(); chartOthers?.resize(); }, 0);
  }
  btnChartTgl?.addEventListener('click', ()=>{
    const on = !chartsBox.classList.contains('collapsed');
    setChartsCollapsed(on);
  });
  chartPh?.addEventListener('click', ()=> setChartsCollapsed(false));

  // ===== è·¯ç”± + åˆ†é åç¨± =====
  const pageNameEl = document.getElementById('pageName');
  const pageNames  = { info:'è³‡è¨Š', home:'è¨˜å¸³', insights:'åˆ†æ', code:'ç¨‹å¼' };

  function showPage(name){
    $('#page-info').hidden     = (name !== 'info');
    $('#page-home').hidden     = (name !== 'home');
    $('#page-insights').hidden = (name !== 'insights');
    $('#page-code').hidden     = (name !== 'code');
    $$('.sb-link').forEach(b=> b.classList.toggle('active', b.dataset.nav === name));
    pageNameEl.textContent = pageNames[name] || '';
    if (name === 'insights') { setDrawer(false); loadRows(); }
    if (name === 'info')     { loadInfo(); }
    if (name === 'code')     { initCodePage(); }
  }
  function applyHash(){
    const h = (location.hash || '#info').replace('#','');
    showPage(['info','home','insights','code'].includes(h) ? h : 'info');
  }
  window.addEventListener('hashchange', applyHash);
  applyHash();

/* === åˆ†æé ï¼šåŠ ç¸½åˆ— ===
   - é¡¯ç¤ºç›®å‰ã€Œé¡åˆ¥ã€çš„é¸å–ï¼ˆ= å·¦æŠ½å±œ chips çš„ activeï¼‰
   - å³å´é¡¯ç¤ºé‡‘é¡åˆè¨ˆï¼ˆåœ¨ filteredRows åŸºç¤ä¸Šå†ä¾é¡åˆ¥èšåˆï¼‰
   - é»æ°£æ³¡ â†’ å–æ¶ˆè©²é¡åˆ¥ï¼ˆç­‰åŒå–æ¶ˆå·¦æŠ½å±œ chipï¼‰ä¸¦é‡ç®—
*/
function renderSumBar(){
  const sumTagsBox = document.getElementById('sumTags');
  const sumTotalEl = document.getElementById('sumTotal');
  if (!sumTagsBox || !sumTotalEl) return;

  // ç›®å‰ã€Œæœ‰è¢«é¸ä¸­ã€çš„é¡åˆ¥ï¼ˆ= å·¦æŠ½å±œ chips.activeï¼‰
  const activeCats = Array.from(document.querySelectorAll('#chipsCat .chip.active'))
    .map(b => b.dataset.val);

  // å¦‚æœæ²’æœ‰ä»»ä½•é¡åˆ¥è¢«é¸ä¸­ï¼Œèªæ„ä¸Šï¼å…¨éƒ¨é¡åˆ¥
  const usingAll = activeCats.length === 0;

  // æº–å‚™è¦é¡¯ç¤ºåœ¨å·¦é‚Šçš„å°æ°£æ³¡å€‘
  sumTagsBox.innerHTML = '';
  if (usingAll){
    const tag = document.createElement('span');
    tag.className = 'sum-tag is-all';
    tag.textContent = 'å…¨éƒ¨é¡åˆ¥';
    sumTagsBox.appendChild(tag);
  } else {
    activeCats.forEach(cat=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'sum-tag';
      btn.innerHTML = `<span>${cat}</span><span class="x">Ã—</span>`;
      btn.addEventListener('click', ()=>{
        // å–æ¶ˆå·¦æŠ½å±œå°æ‡‰ chip çš„ active
        const chip = Array.from(document.querySelectorAll('#chipsCat .chip'))
          .find(c => c.dataset.val === cat);
        if (chip){ chip.classList.remove('active'); }
        applyFilters(); // æœƒé †ä¾¿é‡ç•«è¡¨æ ¼/åœ–è¡¨/åŠ ç¸½åˆ—
      });
      sumTagsBox.appendChild(btn);
    });
  }

  // è¨ˆç®—åŠ ç¸½ï¼šåœ¨ã€Œå·²å¥—ç”¨å…¶ä»–æ¢ä»¶ã€çš„ filteredRows è£¡å†æ ¹æ“š activeCats åˆè¨ˆ
  let total = 0;
  // ç•¶ä½¿ç”¨ã€Œå…¨éƒ¨ã€æ™‚ï¼Œå®¹è¨±æ‰€æœ‰é¡åˆ¥ï¼›å¦å‰‡åªç®— activeCats å…§çš„
  const allowSet = usingAll
    ? null
    : new Set(activeCats);

  filteredRows.forEach(r=>{
    const cat = (r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰').trim();
    if (allowSet && !allowSet.has(cat)) return;
    // é€™è£¡ä»¥ã€Œé‡‘é¡ç›¸åŠ ã€ç‚ºæº–ï¼ˆä¸è«–æ”¶å…¥/æ”¯å‡ºï¼‰
    // è‹¥ä½ è¦æŠŠæ”¯å‡ºè¦–ç‚ºè² æ•¸ï¼Œæ”¹æˆï¼šconst val = (r.type === 'æ”¯å‡º' ? -1 : 1) * Number(r.amount||0)
    const val = Number(r.amount || 0);
    total += val;
  });

  sumTotalEl.textContent = total.toLocaleString();
}
  
})();
</script>