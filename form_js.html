<script>

(function(){
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
    // ä¾é¡åˆ¥æ¨æ–·çš„å‹åˆ¥ï¼ˆæ”¶å…¥/æ”¯å‡º/ä¸­æ€§ï¼‰
  const categoryTypeMap = Object.create(null);
  let allCategoriesRaw = [];
  let CURRENT_BALANCE_ALL = 0;

  // èˆŠè·¯ç”±åˆ¥å â†’ æ–°è·¯ç”± ID å°ç…§ï¼ˆé¿å…æ®˜ç•™çš„ data-nav/href ä»å¯«èˆŠå€¼ï¼‰
  const LEGACY_HASH_MAP = { info:'form_info', home:'form_input', insights:'form_data', code:'form_code', links:'links' };
  const normalizeRoute = (name)=> LEGACY_HASH_MAP[name] || name;

  // ---- é€šç”¨ï¼šé»æ“Š data-copy è¤‡è£½æŒ‡å®šç¯€é»çš„æ–‡å­— ----
  function bindCopyDelegation(){
    document.addEventListener('click', function(e){
      var btn = e.target.closest('[data-copy]');
      if (!btn) return;
      var sel = btn.getAttribute('data-copy');
      var el  = sel ? document.querySelector(sel) : null;
      if (!el) return;
      var txt = (el.textContent || '').trim();
      if (!txt) return;
      (navigator.clipboard && navigator.clipboard.writeText
        ? navigator.clipboard.writeText(txt)
        : (function(){ var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return Promise.resolve(); })()
      ).then(function(){
        var old = btn.textContent; btn.textContent = 'å·²è¤‡è£½';
        setTimeout(function(){ btn.textContent = old || 'è¤‡è£½'; }, 900);
      }).catch(function(){});
    });
  }
  bindCopyDelegation();

  // ---- éŸ¿æ‡‰å¼ï¼šæ‰‹æ©Ÿéš±è—å³ä¸Š menuï¼Œäº®æš—æŒ‰éˆ•æ”¾å¤§ ----
  function applyMobileTweaks(){
    var isMobile = window.innerWidth <= 1024;
    var topMenu  = document.getElementById('btnMenu');
    if (topMenu){ topMenu.style.display = isMobile ? 'none' : ''; }
    var thL = document.getElementById('thLight');
    var thD = document.getElementById('thDark');
    [thL, thD].forEach(function(btn){
      if (!btn) return;
      btn.style.transform = isMobile ? 'scale(2)' : '';
      btn.style.transformOrigin = 'center';
    });
    if (thD) thD.style.marginLeft = isMobile ? '12px' : '';
    if (thL) thL.style.marginRight = isMobile ? '12px' : '';
  }
  window.addEventListener('resize', applyMobileTweaks);
  applyMobileTweaks();

  // ---- æ‰‹æ©Ÿ tabbarï¼šactive åŒæ­¥ + Menu sheet é–‹é—œï¼ˆåƒ…è¡Œç‚ºï¼Œæ¨£å¼ä¹‹å¾Œèª¿ï¼‰ ----
  function highlightTab(name){
    $$('.tabbar .tab-item').forEach(function(el){ el.classList.toggle('active', el.dataset.nav === name); });
  }
  (function bindTabbar(){
    var tb = document.querySelector('.tabbar');
    if (!tb) return;
    tb.addEventListener('click', function(e){
      var a = e.target.closest('.tab-item[href^="#"]');
      if (!a) return;
      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', function(){
          highlightTab((location.hash||'#form_info').replace('#',''));
        });
      } else {
        highlightTab((location.hash||'#form_info').replace('#',''));
      }
    });
    var menuBtn = document.getElementById('tabMenu');
    var sheet   = document.getElementById('menuSheet');
    if (menuBtn && sheet){
      menuBtn.addEventListener('click', function(){ sheet.classList.toggle('open'); sheet.setAttribute('aria-hidden', sheet.classList.contains('open') ? 'false' : 'true'); });
      // é¡å¤–åŠ ä¸€çµ„æ˜ç¢ºçš„ click ç¶å®šï¼Œç¢ºä¿å³ä½¿å…¶ä»– handler é˜»æ“‹ä¹Ÿèƒ½åˆ‡æ›
      menuBtn.addEventListener('click', function(ev){ ev.preventDefault(); ev.stopPropagation(); sheet.classList.toggle('open'); sheet.setAttribute('aria-hidden', sheet.classList.contains('open') ? 'false' : 'true'); });
      // æœ€é«˜å„ªå…ˆæ¬Šçš„å…¨åŸŸæ•ç²ï¼Œé¿å…è¢«å…¶å®ƒ handler åƒæ‰
      document.addEventListener('click', function(ev){
        var t = ev.target;
        if (t && t.closest && t.closest('#tabMenu')){
          ev.preventDefault(); ev.stopPropagation();
          sheet.classList.toggle('open');
          sheet.setAttribute('aria-hidden', sheet.classList.contains('open') ? 'false' : 'true');
        }
      }, true);
      sheet.addEventListener('click', function(e){ if (e.target === sheet) { sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); } });
      sheet.querySelectorAll('[data-nav]').forEach(function(btn){
        btn.addEventListener('click', function(){
          var dest = btn.getAttribute('data-nav');
          if (dest){ location.hash = '#' + normalizeRoute(dest.replace('#','')); }
          sheet.classList.remove('open');
          sheet.setAttribute('aria-hidden','true');
        });
      });
      // ä¹Ÿå…è¨±ç”¨ ESC é—œé–‰
      document.addEventListener('keydown', function(e){ if (e.key === 'Escape'){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); } });
    }
  })();

  function monthRange(d){
    var y = d.getFullYear(), m = d.getMonth();
    var from = new Date(y, m, 1);
    var to   = new Date(y, m+1, 0, 23,59,59,999);
    return { from: from, to: to };
  }

// ---- æ—¥æœŸé¡¯ç¤ºï¼šæŠŠ input çš„å€¼è½‰æˆ MM/DD é¡¯ç¤ºåœ¨ç›¸é„° .date-display ----
function bindShortDate(inpId, dispId){
  const inp = document.getElementById(inpId);
  const disp = document.getElementById(dispId);
  if (!inp || !disp) return;
  const sync = ()=>{
    if (inp.value) {
      const [y,m,d] = inp.value.split('-');
      disp.textContent = `${m}/${d}`;
    } else {
      disp.textContent = (dispId === 'dispFrom') ? 'èµ·å§‹æ—¥' : (dispId === 'dispTo' ? 'æˆªæ­¢æ—¥' : 'â€”/â€”');
    }
  };
  inp.addEventListener('change', ()=>{ sync(); applyFilters(); });
  inp.addEventListener('input',  sync);
  sync();
}

// åˆå§‹åŒ–ï¼ˆæ”¾åœ¨ä½  loadRows() ä¹‹å¾Œæˆ–è·¯ç”±åˆ‡åˆ° insights å¾Œï¼‰
bindShortDate('fltFrom','dispFrom');
bindShortDate('fltTo','dispTo');

// å¿«æ·éµï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„ data-q é‚è¼¯ï¼Œè¨˜å¾—åˆ·æ–°é¡¯ç¤ºï¼‰
document.querySelectorAll('.segbtn[data-q]').forEach(btn=>{
  btn.onclick = ()=>{
    const tag = btn.dataset.q;
    const now = new Date();
    const y = now.getFullYear(), m = now.getMonth();

    if (tag === 'this-month'){
      const from = new Date(y, m, 1).toISOString().slice(0,10);
      const to   = new Date(y, m+1, 0).toISOString().slice(0,10);
      document.getElementById('fltFrom').value = from;
      document.getElementById('fltTo').value   = to;
    } else { // 'all'
      document.getElementById('fltFrom').value = '';
      document.getElementById('fltTo').value   = '';
    }
    // æ›´æ–°é¡¯ç¤º + è§¸ç™¼ç¯©é¸
    const ev = new Event('change');
    document.getElementById('fltFrom').dispatchEvent(ev);
    document.getElementById('fltTo').dispatchEvent(ev);
  };
});

// 1) é è¨­æš—è‰²ä¸»é¡Œï¼ˆè‹¥å°šæœªæŒ‡å®šï¼‰
(function ensureDarkDefault(){
  var root = document.documentElement;
  if (!root.getAttribute('data-theme')) {
    root.setAttribute('data-theme', 'dark');
  }
})();

// 2) sumbarï¼šç§»é™¤ä¸­æ–‡å†’è™Ÿï¼ˆï¼šï¼‰ï¼Œä¿ç•™æ–‡å­—æœ¬èº«
(function stripSumbarColons(){
  try{
    var ids = ['sumTotal','sumBalanceAll'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if (!el) return;
      // å˜—è©¦è™•ç†å‰ä¸€å€‹å…„å¼Ÿç¯€é»è‹¥æ˜¯æ–‡å­—ç¯€é»ï¼Œç§»é™¤å…¶ä¸­çš„ã€Œï¼šã€
      var prev = el.previousSibling;
      if (prev && prev.nodeType === Node.TEXT_NODE) {
        prev.textContent = (prev.textContent || '').replace(/ï¼š/g,'');
      }
      // è‹¥å‰ä¸€å€‹æ˜¯å…ƒç´ ç¯€é»ä¸”å«æœ‰å†’è™Ÿçš„æ–‡å­—ï¼Œä¹Ÿå˜—è©¦æ¸…æ‰
      if (prev && prev.nodeType === Node.ELEMENT_NODE) {
        var txt = prev.textContent || '';
        if (txt.indexOf('ï¼š') >= 0) prev.textContent = txt.replace(/ï¼š/g,'');
      }
    });
  }catch(e){ console.warn('stripSumbarColons failed', e); }
})();

  // ===== ä¸»é¡Œåˆ‡æ› =====
  const root = document.documentElement;
  const thLight = $('#thLight'), thDark = $('#thDark');
  function setTheme(mode){
    root.setAttribute('data-theme', mode === 'dark' ? 'dark' : 'light');
    localStorage.setItem('theme-mode', mode);
    [thLight, thDark].forEach(b=>b.classList.remove('active'));
    (mode === 'dark' ? thDark : thLight).classList.add('active');
  }
  setTheme(localStorage.getItem('theme-mode') || 'light');
  thLight.onclick = ()=> setTheme('light');
  thDark.onclick  = ()=> setTheme('dark');

  // ===== å³å´æŠ½å±œï¼ˆä¸»é¸å–®ï¼‰ =====
  const sidebar = $('#sidebar');
  $('#btnMenu').addEventListener('click', ()=>{
    const open = sidebar.classList.toggle('open');
    sidebar.setAttribute('aria-hidden', open ? 'false' : 'true');
  });
  $('#sbClose').addEventListener('click', ()=>{
    sidebar.classList.remove('open');
    sidebar.setAttribute('aria-hidden','true');
  });
  $$('.sb-link').forEach(b=> b.addEventListener('click', ()=>{
    const dest = normalizeRoute((b.dataset.nav||'').replace('#',''));
    if (dest) location.hash = '#' + dest;
    sidebar.classList.remove('open');
    sidebar.setAttribute('aria-hidden','true');
  }));

  // ===== Topbar metaï¼šåªé¡¯ç¤ºä»Šæ—¥æ—¥æœŸï¼ˆåœ°å€ç§»é™¤ï¼‰ =====
  const meta = $('#meta');
  (function showTopDate(){
    const todayStr = new Intl.DateTimeFormat('zh-TW', {
      timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit'
    }).format(new Date());
    meta.textContent = todayStr;
  })();

  // ===== è¡¨å–®ï¼ˆè¨˜å¸³ï¼‰ =====
  const f = $('#f'), msg = $('#msg'), submitBtn = $('#submitBtn');
  const selCat = $('#category'), selPayer = $('#payer');
  const today = new Date();
  const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);
  if (f) f.date.value = iso;
  // ç•¶æ”¶å…¥/æ”¯å‡º/ä¸­æ€§åˆ‡æ›æ™‚ï¼Œä¾å‹åˆ¥éæ¿¾ã€Œé …ç›®é¡åˆ¥ã€ä¸‹æ‹‰
  document.querySelectorAll('input[name="type"]').forEach(function(r){ r.addEventListener('change', filterCategoryOptionsByType); });
  function tip(text){ if (!msg) return; msg.textContent = text||''; if (text) setTimeout(()=> msg.textContent='', 2500); }
  function fmt(n){ return (Number(n||0)).toLocaleString(); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ====== decorateTypePillsï¼šæ¸²æŸ“å‹åˆ¥è† å›Š ======
  function decorateTypePills(){
    try{
      var rows = document.querySelectorAll('#tbl tbody tr');
      rows.forEach(function(tr){
        var td = tr.querySelector('td[data-k="type"], td:nth-child(5)');
        if (!td) return;
        var txt = (td.textContent||'').trim();
        var klass = 'pill-neutral';
        if (txt === 'æ”¶å…¥') klass = 'pill-income';
        else if (txt === 'æ”¯å‡º') klass = 'pill-expense';
        td.innerHTML = '<span class="pill '+klass+'">'+txt+'</span>';
      });
    }catch(e){ console.warn('decorateTypePills failed', e); }
  }

  function loadOptions(){
    google.script.run
      .withSuccessHandler(opt=>{
        allCategoriesRaw = (opt && opt.categories) || [];
        if (selPayer) fillSelect(selPayer, (opt && opt.payers) || []);
        filterCategoryOptionsByType();
      })
      .withFailureHandler(err=> console.warn('readOptions fail:', err && err.message))
      .readOptions();
  }
  function fillSelect(sel, arr){
    sel.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡</option>` +
      arr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('') +
      `<option value="__ADD__">ï¼‹ æ–°å¢é¡åˆ¥â€¦</option>`;
  }

  function filterCategoryOptionsByType(){
    if (!selCat) return;
    const checked = document.querySelector('input[name="type"]:checked');
    const t = checked ? checked.value : 'æ”¯å‡º';
    const cur = selCat.value;
    let arr = (t === 'ä¸­æ€§')
      ? (Array.isArray(allCategoriesRaw) ? allCategoriesRaw.slice() : [])
      : (Array.isArray(allCategoriesRaw) ? allCategoriesRaw.filter(function(c){
          const m = categoryTypeMap[c];
          return (m == null) || (m === t);
        }) : []);
    // è‹¥éæ¿¾å¾Œç‚ºç©ºï¼Œé€€å›å…¨æ¸…å–®ï¼Œé¿å…ä¸‹æ‹‰è®Šæˆç„¡é¸é …
    if ((!arr || arr.length === 0) && Array.isArray(allCategoriesRaw) && allCategoriesRaw.length){
      arr = allCategoriesRaw.slice();
    }
    fillSelect(selCat, arr);
    // è‹¥åŸå…ˆé¸é …ä»å­˜åœ¨ï¼Œä¿ç•™é¸å–
    if (cur && Array.from(selCat.options).some(o=>o.value===cur)) selCat.value = cur;
  }
  loadOptions();

  // é¡åˆ¥ä¸‹æ‹‰çš„ã€Œï¼‹ æ–°å¢é¡åˆ¥â€¦ã€è¡Œç‚º
  (function enableAddCategory(){
    var selCat = document.getElementById('category');
    if (!selCat) return;
    selCat.addEventListener('change', function(){
      if (this.value !== '__ADD__') return;
      var ioSel = document.querySelector('input[name="type"]:checked');
      var seed  = ioSel ? ioSel.value : 'æ”¯å‡º'; // æ”¶å…¥ / æ”¯å‡º / ä¸­æ€§
      var name = (prompt('è¼¸å…¥æ–°é¡åˆ¥åç¨±ï¼šå¦‚ã€Œç§Ÿé‡‘æ”¶å…¥ã€æˆ–ã€Œè£œåŠ©/é€€ç¨…ã€') || '').trim();
      if ([...this.options].some(o=>o.value===name)){
        this.value = name;
        return;
      }
      if (!name) { this.value = ''; return; }
      // å‰ç«¯å³æ™‚æ’å…¥ä¸¦é¸ä¸­
      var addOpt = document.createElement('option');
      addOpt.value = name; addOpt.textContent = name;
      this.insertBefore(addOpt, this.querySelector('option[value="__ADD__"]'));
      this.value = name;
      // å¾Œç«¯æŒä¹…åŒ–ï¼ˆä¸å»ºç«‹æ–°åˆ†é ï¼Œå­˜åœ¨å±¬æ€§ä¸­ï¼‰
      google.script.run
        .withFailureHandler(function(err){ alert('æ–°å¢é¡åˆ¥å¤±æ•—ï¼š' + (err && err.message || err)); })
        .addCategory({ name: name, ioType: seed });
    });
  })();
  // æ’é™¤æ¸…å–®ï¼ˆé¡åˆ¥åç¨±ï¼‰èˆ‡ã€Œä¸è¨ˆæç›Šã€å‹åˆ¥
  const EXCLUDE_CATS  = new Set(['æ”¶å…¥','ä¸­ä¿¡è‡ªå‹•æ‰£']);
  const EXCLUDE_TYPES = new Set(['ä¸­æ€§']);
  // æ”¶å…¥çµ„æˆæ’é™¤ï¼šæ¯”ç…§æ”¯å‡ºçµ„æˆé¢¨æ ¼ï¼Œæ”¹æˆå¯èª¿å¼è¦å‰‡ï¼ˆå«å¸¸è¦‹å¯«æ³•ï¼‰
  const EXCLUDE_INCOME_RULE = {
    byExact: new Set(['èè³‡/å€Ÿæ¬¾','æŠ¼é‡‘','æŠ¼é‡‘èè³‡ / å€Ÿæ¬¾','æˆ¿è²¸ç¸½é¡']),
    byMatch: /(èè³‡|å€Ÿæ¬¾|æŠ¼é‡‘|æˆ¿è²¸ç¸½é¡)/
  };

  if (f){
    f.addEventListener('submit', (e)=>{
      e.preventDefault();
      submitBtn.disabled = true; tip('é€å‡ºä¸­â€¦');
      const payload = Object.fromEntries(new FormData(f).entries());
      google.script.run
        .withSuccessHandler(()=>{
          tip('å·²æ–°å¢ âœ…');
          f.reset(); f.date.value = iso;
          refreshTotals(); loadOptions();
          if (!document.getElementById('form_data')?.hasAttribute('hidden')) { loadRows(); refreshCharts(); }
          submitBtn.disabled = false;
        })
        .withFailureHandler(err=>{
          tip('å¤±æ•—ï¼š' + (err && err.message || err));
          submitBtn.disabled = false;
        })
        .writeEntry(payload);
    });
  }

  // KPI
  function renderKpis(d){
    $('#inkIncome').textContent  = fmt(d.totalIncome);
    $('#inkExpense').textContent = fmt(d.totalExpense);
    $('#inkBalance').textContent = fmt(d.balance);
  }
  function refreshTotals(){
    google.script.run
      .withSuccessHandler(function(res){
        const raw = Array.isArray(res && res.rows) ? res.rows : [];
        const rows = raw.map(function(r){
          const amt = Number(String(r.amount||'').replace(/,/g,'').trim()) || 0;
          const tit = String(r.title||'').trim();
          const typ = String(r.type||'').trim();
          return { amount: amt, title: tit, type: typ };
        });
        // è¦å‰‡ï¼š
        // 1) ç¸½æ”¶å…¥ï¼šæ‰€æœ‰ type==='æ”¶å…¥' çš„é‡‘é¡
        // 2) ç¸½æ”¯å‡ºï¼šæ‰€æœ‰ type==='æ”¯å‡º'ï¼Œä½†æ’é™¤ é …ç›®åç¨± === 'ä¸­æ€§è‡ªå‹•æ‰£'
        // 3) ç›®å‰é¤˜é¡ï¼šå…¨éƒ¨åŠ ç¸½ï¼ˆæ”¶å…¥åŠ ï¼Œæ”¯å‡ºæ¸›ï¼›ä¸åšä»»ä½•æ’é™¤ï¼‰
        let income = 0, expense = 0, balance = 0;
        rows.forEach(function(r){
          if (r.type === 'æ”¶å…¥'){
            income += r.amount;
            balance += r.amount;
          } else if (r.type === 'æ”¯å‡º'){
            if (r.title !== 'ä¸­æ€§è‡ªå‹•æ‰£') expense += r.amount; // KPI å°ˆç”¨æ’é™¤
            balance -= r.amount; // é¤˜é¡ä¸€å¾‹æ‰£é™¤
          }
        });
        CURRENT_BALANCE_ALL = balance; // æä¾› sumBar ä½¿ç”¨
        const fN = n => Number(n||0).toLocaleString();
        const EI = document.getElementById('inkIncome');  if (EI) EI.textContent  = fN(income);
        const EE = document.getElementById('inkExpense'); if (EE) EE.textContent = fN(expense);
        const EB = document.getElementById('inkBalance'); if (EB) EB.textContent = fN(balance);
      })
      .withFailureHandler(function(err){ console.warn('readRowsLatest for totals fail:', err && err.message || err); })
      .readRowsLatest(50000);
  }
  $('#refreshBtn')?.addEventListener('click', ()=>{ refreshTotals(); loadOptions(); });
  refreshTotals();

  // ===== Info é ï¼šlogo + è²¸æ¬¾é€²åº¦ + ç›®å‰é¤˜é¡ =====
  function loadInfo(){
      // 1) è®€ logo
      google.script.run.withSuccessHandler(res => {
        const img = document.getElementById('infoLogo');
        const url = (res && res.url || '').trim();
        const box = img?.closest('.logo-box');        // ä½ ä¸Šä¸€ç‰ˆæœ‰çš„ logo å®¹å™¨ï¼ˆè‹¥æ²’ç”¨ logo-box ä¹Ÿæ²’é—œä¿‚ï¼‰
        const infoSection = document.getElementById('form_info');
        if (!img || !url || !infoSection) return;

        img.onload = () => {
          // è¨­å®šè³‡è¨Šé èƒŒæ™¯ä½¿ç”¨åŒä¸€å¼µåœ–ç‰‡
          infoSection.style.setProperty('--hero-img', `url("${url}")`);
          // è¦–éœ€è¦å¯èª¿æ•´æ•´é«”é€æ˜åº¦ï¼ˆ0~1ï¼‰
          infoSection.style.setProperty('--hero-overlay-alpha', '0.92');

          // ä½ çš„è‡ªé©æ‡‰ logo å¯¬é«˜æ¯”ä¾‹èˆ‡å…©å€å°ºå¯¸è¨­å®šï¼ˆä¿æŒåŸé‚è¼¯ï¼‰
          const nw = img.naturalWidth || 1;
          const nh = img.naturalHeight || 1;
          const boxEl = box || img.parentElement;
          if (boxEl){
            boxEl.style.setProperty('--logo-ar', `${nw}/${nh}`);
            boxEl.style.setProperty('--logo-w', '360px'); // 2x å°ºå¯¸
          }
          img.style.display = 'block';
        };

        img.onerror = () => {
          console.warn('logo è¼‰å…¥å¤±æ•—ï¼š', url);
          // èƒŒæ™¯ä¹Ÿå°±ä¸è¨­äº†ï¼Œä¿æŒåŸæœ¬åº•è‰²
        };

        img.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();

      // åœ°å€è¤‡è£½æŒ‰éˆ•ï¼šè‹¥ä¸å­˜åœ¨å‰‡è¼•é‡æ³¨å…¥ï¼ˆæ­é… bindAddrCopyButtons è‡ªå‹•é‡ç½®åœ–ç¤ºï¼‰
      function injectAddrCopyIfMissing(targetId){
        var target = document.getElementById(targetId); if (!target) return;
        var next = target.nextElementSibling;
        if (next && next.classList && next.classList.contains('addr-copy')) return;
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn ghost addr-copy';
        btn.setAttribute('data-copy-target', '#'+targetId);
        btn.title = 'è¤‡è£½åœ°å€';
        btn.innerHTML = '<span class="micon" style="font-size:18px;line-height:1;vertical-align:middle;">content_copy</span>';
        // èˆ‡åœ°å€åŒä¸€è¡Œé¡¯ç¤º
        var parent = target.parentElement;
        if (parent){ parent.style.display='flex'; parent.style.alignItems='center'; parent.style.gap='8px'; }
        target.insertAdjacentElement('afterend', btn);
      }
      injectAddrCopyIfMissing('addrZh');
      injectAddrCopyIfMissing('addrEn');

         // ğŸ’¡ é‡é»ï¼šè¨­å®šå…¨å±èƒŒæ™¯ç”¨çš„ CSS è®Šæ•¸
        document.body.style.setProperty('--hero-img', `url("${url}")`);
        document.body.style.setProperty('--hero-overlay-alpha', '0.92');

      }).getLogoUrl();

      // 2) è®€è²¸æ¬¾é€²åº¦ï¼ˆç¶­æŒåŸæœ¬ï¼‰
      google.script.run
        .withSuccessHandler(d=>{
          const fN = n => (Number(n||0)).toLocaleString();
          document.getElementById('loanPaid').textContent  = fN(d.paid);
          document.getElementById('loanTotal').textContent = fN(d.total);
          document.getElementById('loanPct').textContent   = (d.percent ?? 0) + '%';
          document.getElementById('loanBar').style.width   =
            Math.max(0, Math.min(100, Number(d.percent || 0))) + '%';
        })
        .withFailureHandler(err=> console.warn('readLoanProgress fail:', err && err.message || err))
        .readLoanProgress();

      // 3) ç›®å‰é¤˜é¡
      google.script.run
        .withSuccessHandler(t => {
          document.getElementById('loanBalance').textContent =
            (Number(t?.balance||0)).toLocaleString();
        })
        .withFailureHandler(() => {
          document.getElementById('loanBalance').textContent = 'â€”';
        })
        .readTotals();

      // 4) Info é  KPI èˆ‡æ”¯å‡ºçµ„æˆï¼ˆæŠ“è³‡æ–™å¾Œåœ¨å‰ç«¯è¨ˆç®—ï¼‰
      google.script.run
        .withSuccessHandler(function(res){
          var raw = Array.isArray(res && res.rows) ? res.rows : [];
          var rows = raw.map(function(r){
            var amt = Number(String(r.amount||'').replace(/,/g,'').trim()) || 0;
            var d = null;
            if (r.dateStr){
              var m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
              d = m ? new Date(+m[1], +m[2]-1, +m[3]) : new Date(r.dateStr);
            }
            if (!(d instanceof Date) || isNaN(d)) d = new Date(0);
            return { title:r.title, category:r.category, amount:amt, type:r.type, payer:r.payer, dateStr:r.dateStr, __date:d };
          });
                    // å»ºç«‹ã€Œé¡åˆ¥ -> ä¸»è¦å‹åˆ¥ã€çš„æ˜ å°„ï¼ˆç”¨æ–¼ç¯©é¸èˆ‡é è¨­ï¼‰
          (function buildCategoryTypeMap(){
            const count = Object.create(null); // key: cat + '|' + type => æ¬¡æ•¸
            rows.forEach(function(r){
              const cat = (r.category||'').trim(); const t = (r.type||'').trim();
              if (!cat || !t) return;
              const key = cat + '|' + t;
              count[key] = (count[key]||0) + 1;
            });
            const seenCats = new Set();
            Object.keys(count).forEach(function(key){ seenCats.add(key.split('|')[0]); });
            seenCats.forEach(function(cat){
              let bestT=null, bestN=-1;
              ['æ”¶å…¥','æ”¯å‡º','ä¸­æ€§'].forEach(function(t){ const n = count[cat+'|'+t]||0; if (n>bestN){ bestN=n; bestT=t; } });
              if (bestT) categoryTypeMap[cat]=bestT;
            });
          })();
          renderInfoKPIs(rows);
          renderInfoCatbar(rows);
          renderInfoIncbar(rows);
  function renderInfoIncbar(rows){
    var catMap = new Map();
    var total = 0;
    rows.forEach(function(r){
      if (r.type !== 'æ”¶å…¥') return; // åƒ…çµ±è¨ˆæ”¶å…¥
      var cat = String(r.category||'').trim();
      if (EXCLUDE_INCOME_RULE.byExact.has(cat) || EXCLUDE_INCOME_RULE.byMatch.test(cat)) return;
      var n = Number(r.amount||0) || 0; if (n<=0) return;
      total += n; var cur = catMap.get(cat)||0; catMap.set(cat, cur+n);
    });

    var track = document.getElementById('incbar-track');
    var totalEl = document.getElementById('incbar-total');
    var legend = document.getElementById('inclegend');
    if (!track || !legend || !totalEl) return;
    track.innerHTML = ''; legend.innerHTML = '';
    if (total <= 0){ totalEl.textContent = 'â€”'; return; }
    totalEl.textContent = Number(total).toLocaleString();

    var left = 0;
    Array.from(catMap.entries()).sort(function(a,b){ return b[1]-a[1]; }).forEach(function(entry){
      var cat = entry[0], val = entry[1];
      var pct = (val/total)*100;
      var seg = document.createElement('span');
      seg.className = 'seg'; seg.style.position='absolute'; seg.style.top='0'; seg.style.bottom='0';
      seg.style.left = left + '%'; seg.style.width = pct + '%'; seg.style.background = colorFor(cat);
      track.appendChild(seg);
      left += pct;

      var li = document.createElement('span');
      li.className = 'legend-item';
      li.innerHTML = '<i class="dot" style="display:inline-block;width:10px;height:10px;border-radius:999px; background:'+colorFor(cat)+';"></i> ' +
                     escapeHtml(cat) + ' ' + Number(val).toLocaleString();
      legend.appendChild(li);
    });
  }
        })
        .withFailureHandler(function(err){ console.warn('readRowsLatest for info fail:', err && err.message || err); })
        .readRowsLatest(50000);
    }

  // ===== Info é ï¼šæœ¬æœˆé‡é» KPI + é¡åˆ¥æ”¯å‡ºçµ„æˆ =====
  function numberSum(arr){ var s=0; for (var i=0;i<arr.length;i++){ s += Number(arr[i]||0); } return s; }
  function isInMonth(d, range){ return d && d >= range.from && d <= range.to; }

  // å»ºç«‹ KPI è¨ˆæ•¸è† å›Š
  function setKpiWithCount(id, value, count){
    var el = document.getElementById(id);
    if (!el) return;
    el.textContent = Number(value||0).toLocaleString();
    var parent = el.parentElement; // è®“çˆ¶å±¤æ©«å‘æ’åˆ—
    if (parent){ parent.style.display = 'flex'; parent.style.alignItems = 'baseline'; parent.style.gap = '8px'; }
    var pill = el.nextElementSibling && el.nextElementSibling.classList && el.nextElementSibling.classList.contains('kpi-pill') ? el.nextElementSibling : null;
    if (!pill){ pill = document.createElement('span'); pill.className = 'kpi-pill'; pill.style.padding = '2px 8px'; pill.style.borderRadius = '999px'; pill.style.fontSize = '12px'; pill.style.opacity = '0.85'; pill.style.border = '1px solid currentColor'; el.insertAdjacentElement('afterend', pill); }
    pill.textContent = 'å…±' + String(count||0) + 'ç­†';
  }

  function colorFor(key){
    // ç©©å®šåˆ†é…è‰²ï¼šä¾å­—ä¸²é›œæ¹Šå¾ä¸€çµ„èª¿è‰²ç›¤å–è‰²
    var palette = ['#6AA6FF','#8E9AFF','#F6A560','#6BD6A8','#F279B2','#A3DC6B','#B38CFF','#FFB86B','#60C7F6','#FF7A7A'];
    var h=0; for (var i=0;i<key.length;i++){ h = ((h<<5)-h) + key.charCodeAt(i); h |= 0; }
    var idx = Math.abs(h) % palette.length; return palette[idx];
  }

  function renderInfoKPIs(rows){
    var mr = monthRange(new Date());
    var inMonth = rows.filter(function(r){ var d = r.__date; return isInMonth(d, mr); });
    var incThis = numberSum(inMonth.filter(function(r){ return r.type==='æ”¶å…¥' && !EXCLUDE_TYPES.has(r.type); }).map(function(r){ return r.amount; }));
    var expThis = numberSum(inMonth.filter(function(r){ return r.type==='æ”¯å‡º' && !EXCLUDE_TYPES.has(r.type); }).map(function(r){ return r.amount; }));
    var netThis = incThis - expThis;
    var mgmtPaid = numberSum(inMonth.filter(function(r){ return (r.type==='æ”¯å‡º') && /ç®¡ç†è²»/.test(String(r.category||'')); }).map(function(r){ return r.amount; }));
    var utilSum  = numberSum(rows.filter(function(r){ return (r.type==='æ”¯å‡º') && /æ°´é›»/.test(String(r.category||'')); }).map(function(r){ return r.amount; }));
    var equipSum = numberSum(rows.filter(function(r){ return (r.type==='æ”¯å‡º') && /è¨­å‚™/.test(String(r.category||'')); }).map(function(r){ return r.amount; }));

    // è¨ˆæ•¸ï¼ˆæœ¬æœˆç®¡ç†è²» / ç´¯ç©æ°´é›» / ç´¯ç©è¨­å‚™ï¼‰
    var mgmtCount = inMonth.filter(function(r){ return (r.type==='æ”¯å‡º') && /ç®¡ç†è²»/.test(String(r.category||'')); }).length;
    var utilCount = rows.filter(function(r){ return (r.type==='æ”¯å‡º') && /æ°´é›»/.test(String(r.category||'')); }).length;
    var equipCount= rows.filter(function(r){ return (r.type==='æ”¯å‡º') && /è¨­å‚™/.test(String(r.category||'')); }).length;

    // æ–‡å­—
    var netEl = document.getElementById('kpiThisMonth');
    if (netEl) netEl.textContent = (netThis>=0? '' : '-') + Number(Math.abs(netThis)||0).toLocaleString();

    setKpiWithCount('kpiMgmtPaid',     mgmtPaid,  mgmtCount);
    setKpiWithCount('kpiUtilitiesSum', utilSum,   utilCount);
    setKpiWithCount('kpiEquipment',    equipSum,  equipCount);
  }

  function renderInfoCatbar(rows){
    var catMap = new Map();
    var total = 0;
    rows.forEach(function(r){
      if (r.type !== 'æ”¯å‡º') return;           // åƒ…çµ±è¨ˆæ”¯å‡º
      var cat = String(r.category||'').trim();
      if (EXCLUDE_CATS.has(cat)) return;       // æ’é™¤ç‰¹åˆ¥æŒ‡å®šçš„é¡åˆ¥
      var n = Number(r.amount||0) || 0; if (n<=0) return;
      total += n; var cur = catMap.get(cat)||0; catMap.set(cat, cur+n);
    });

    var track = document.getElementById('catbar-track');
    var totalEl = document.getElementById('catbar-total');
    var legend = document.getElementById('catlegend');
    if (!track || !legend || !totalEl) return;
    track.innerHTML = ''; legend.innerHTML = '';
    if (total <= 0){ totalEl.textContent = 'â€”'; return; }
    totalEl.textContent = Number(total).toLocaleString();

    var left = 0;
    Array.from(catMap.entries()).sort(function(a,b){ return b[1]-a[1]; }).forEach(function(entry){
      var cat = entry[0], val = entry[1];
      var pct = (val/total)*100;
      var seg = document.createElement('span');
      seg.className = 'seg'; seg.style.position='absolute'; seg.style.top='0'; seg.style.bottom='0';
      seg.style.left = left + '%'; seg.style.width = pct + '%'; seg.style.background = colorFor(cat);
      track.appendChild(seg);
      left += pct;

      var li = document.createElement('span');
      li.className = 'legend-item';
      li.innerHTML = '<i class="dot" style="display:inline-block;width:10px;height:10px;border-radius:999px; background:'+colorFor(cat)+';"></i> ' +
                     escapeHtml(cat) + ' ' + Number(val).toLocaleString();
      legend.appendChild(li);
    });
  }

  // ===== åˆ†æé  =====
  const tblBody  = $('#tbl tbody');
  const rowCount = $('#rowCount');
  const rowsMsg  = $('#rowsMsg');
  let currentRows = [];
  let filteredRows = [];
  let sortState = { key:'date', dir:'desc' };
  let chartFeatured, chartOthers;

  // ===== ç¨‹å¼é ï¼ˆ#form_codeï¼‰ï¼šè‡ªè¨‚æŒ‡ä»¤ =====
  var codePageBooted = false;
  var customSeq = 0;
  function renderCustomCommands(list){
    var wrap = document.getElementById('customCmdList');
    var empty = document.getElementById('customEmpty');
    if (!wrap) return;
    wrap.innerHTML = '';
    if (!Array.isArray(list) || list.length === 0){
      if (empty) empty.hidden = false;
      return;
    }
    if (empty) empty.hidden = true;
    list.forEach(function(item){
      var id = 'cmd-custom-' + (++customSeq);
      var title = (item && item.title) ? String(item.title) : 'æœªå‘½åæŒ‡ä»¤';
      var note  = (item && item.note)  ? String(item.note)  : '';
      var body  = (item && item.body)  ? String(item.body)  : '';
      var card = document.createElement('div');
      card.className = 'card'; card.style.margin = '0';
      card.innerHTML = ''+
        '<div class="subtitle" style="margin:0 0 6px;">'+ escapeHtml(title) +'</div>'+
        (note ? '<div style="display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:var(--muted); background:color-mix(in oklab, var(--muted) 14%, transparent);">'+ escapeHtml(note) +'</div>' : '')+
        '<pre class="codebox" style="margin-top:10px;"><code id="'+ id +'">'+ escapeHtml(body) +'</code></pre>'+
        '<button class="btn" type="button" data-copy="#'+ id +'">è¤‡è£½</button>';
      wrap.appendChild(card);
    });
  }

  function fetchCustomCommands(){
    if (!document.getElementById('customCmdList')) return;
    google.script.run
      .withSuccessHandler(function(res){ renderCustomCommands(res || []); })
      .withFailureHandler(function(err){ console.warn('listCommands fail:', err && err.message || err); })
      .listCommands();
  }

  function initCodePage(){
    if (codePageBooted) return;
    codePageBooted = true;
    var addBtn   = document.getElementById('btnAddCmd');
    var formWrap = document.getElementById('cmdForm');
    var tInput   = document.getElementById('cmdTitle');
    var nInput   = document.getElementById('cmdNote');
    var bInput   = document.getElementById('cmdBody');
    var okBtn    = document.getElementById('cmdSubmit');
    var cancelBtn= document.getElementById('cmdCancel');

    function openForm(){ if (formWrap) formWrap.hidden = false; }
    function closeForm(){ if (formWrap) formWrap.hidden = true; if (tInput) tInput.value=''; if (nInput) nInput.value=''; if (bInput) bInput.value=''; }

    if (addBtn)   addBtn.addEventListener('click', openForm);
    if (cancelBtn)cancelBtn.addEventListener('click', closeForm);
    if (okBtn) okBtn.addEventListener('click', function(){
      var title = (tInput && tInput.value || '').trim();
      var note  = (nInput && nInput.value || '').trim();
      var body  = (bInput && bInput.value || '').trim();
      if (!title || !body){ alert('è«‹è¼¸å…¥ã€Œæ¨™é¡Œã€èˆ‡ã€ŒæŒ‡ä»¤ã€'); return; }
      okBtn.disabled = true;
      google.script.run
        .withSuccessHandler(function(){ okBtn.disabled = false; closeForm(); fetchCustomCommands(); })
        .withFailureHandler(function(err){ okBtn.disabled = false; alert('æ–°å¢å¤±æ•—ï¼š' + (err && err.message || err)); })
        .addCommand({ title: title, note: note, body: body });
    });

    fetchCustomCommands();
  }

  // å·¦å´ sort æŠ½å±œ
  const fltToggle    = document.getElementById('fltToggle');
  const fltDrawer    = document.getElementById('fltDrawer');
  const pageInsights = document.getElementById('form_data');

  function setDrawer(open){
    if (!fltDrawer || !fltToggle || !pageInsights) return;
    fltDrawer.classList.add('open');
    fltDrawer.setAttribute('aria-hidden','false');
    pageInsights.classList.add('flt-shift');
    fltToggle.style.display = 'none';
    fltDrawer.classList.add('card','flt-fixed');
  }
  fltToggle?.addEventListener('click', ()=> setDrawer(!fltDrawer.classList.contains('open')));

  // ç¯©é¸æ§åˆ¶ï¼ˆchips + segmentedï¼‰
  const fltFrom   = document.getElementById('fltFrom');
  const fltTo     = document.getElementById('fltTo');
  const segType   = document.getElementById('segType');
  const chipsCat  = document.getElementById('chipsCat');
  const chipsPayer= document.getElementById('chipsPayer');

  const DEFAULT_CATS = new Set(['æˆ¿è²¸','æ°´é›»è²»','è¨­å‚™']);
  let selectedTypes  = new Set(['æ”¶å…¥','æ”¯å‡º','ä¸­æ€§']);
  let selectedCats   = new Set(DEFAULT_CATS);
  let selectedPayers = new Set();

  function makeChip(text, on){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'chip' + (on ? ' active' : '');
    b.textContent = text;
    b.dataset.val = text;
    b.addEventListener('click', ()=>{ b.classList.toggle('active'); applyFilters(); });
    return b;
  }

  function buildChipsFromData(rows){
    const cats   = Array.from(new Set(rows.map(r=> r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰'))).sort();
    const payers = Array.from(new Set(rows.map(r=> r.payer    || 'ï¼ˆæœªå¡«ï¼‰'))).sort();

    chipsCat.innerHTML = '';
    selectedCats = new Set();
    cats.forEach(c=>{
      const on = DEFAULT_CATS.has(c);
      if (on) selectedCats.add(c);
      chipsCat.appendChild(makeChip(c, on));
    });

    chipsPayer.innerHTML = '';
    selectedPayers = new Set(payers);
    payers.forEach(p=> chipsPayer.appendChild(makeChip(p, true)));

    // ç¢ºä¿ã€Œä¸­æ€§ã€æŒ‰éˆ•å­˜åœ¨
    if (!segType.querySelector('[data-type="ä¸­æ€§"]')){
      const b = document.createElement('button');
      b.type = 'button'; b.className = 'segbtn active'; b.dataset.type = 'ä¸­æ€§'; b.textContent = 'ä¸­æ€§';
      segType.appendChild(b);
    }
    
    // æ”¶å…¥/æ”¯å‡ºï¼ˆå¯è¤‡é¸ï¼‰
    segType.querySelectorAll('.segbtn').forEach(btn=>{
      btn.onclick = ()=>{
        const v = btn.dataset.type; // æ”¶å…¥ / æ”¯å‡º / ä¸­æ€§
        btn.classList.toggle('active');
        const nowOn = btn.classList.contains('active');
        if (nowOn) selectedTypes.add(v); else selectedTypes.delete(v);
        if (selectedTypes.size === 0){ selectedTypes.add(v); btn.classList.add('active'); }
        // é¡åˆ¥ç¾¤çµ„é è¨­ï¼šä¾æ˜ å°„æ‰¹æ¬¡é–‹/é—œ
        const chips = Array.from(document.querySelectorAll('#chipsCat .chip'));
        chips.forEach(ch=>{
          const cat = ch.dataset.val;
          const t = categoryTypeMap[cat];
          if (t === v){ ch.classList.toggle('active', nowOn); }
        });
        applyFilters();
      };
    });

    fltFrom.onchange = applyFilters;
    fltTo.onchange   = applyFilters;

  }

  function bindAddrCopyButtons(){
    document.querySelectorAll('[data-copy-target]').forEach(function(btn){
      var targetSel = btn.getAttribute('data-copy-target');
      var target = targetSel ? document.querySelector(targetSel) : null;
      if (!target) return;
      var icon = btn.querySelector('.micon');
      var original = icon ? icon.textContent : '';
      var timer = null;
      btn.addEventListener('click', function(){
        var txt = (target.textContent || '').trim();
        if (!txt) return;
        navigator.clipboard.writeText(txt).then(function(){
          if (icon) icon.textContent = 'check';
          if (timer) clearTimeout(timer);
          timer = setTimeout(function(){
            if (icon) icon.textContent = (original || 'content_copy');
          }, 2000);
        });
      });
    });
  }
  // åˆå§‹åŒ–æ™‚å‘¼å«ä¸€æ¬¡
  bindAddrCopyButtons();

  function loadRows(){
    if (!tblBody) return;
    rowsMsg.textContent = 'è¼‰å…¥ä¸­â€¦';
    google.script.run
      .withSuccessHandler(res=>{
        const raw = Array.isArray(res?.rows) ? res.rows : [];
        currentRows = raw.map(r=>{
          const amt = Number(String(r.amount||'').replace(/,/g,'').trim()) || 0;
          let d = null;
          if (r.dateStr){
            const m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
            d = m ? new Date(+m[1], +m[2]-1, +m[3]) : new Date(r.dateStr);
          }
          if (!(d instanceof Date) || isNaN(d)) d = new Date(0);
          return { ...r, amount: amt, date: d };
        });

        buildChipsFromData(currentRows);
        fltFrom.value = ''; fltTo.value = '';   // é è¨­ã€Œå…¨éƒ¨ã€
        setDrawer(true);
        if (fltDrawer){ fltDrawer.style.margin = '0 auto 12px'; fltDrawer.style.maxWidth = '1200px'; }
        applyFilters();
        rowsMsg.textContent = '';
      })
      .withFailureHandler(err=>{
        rowsMsg.textContent = 'è®€å–å¤±æ•—ï¼š' + (err?.message || err);
        console.error('readRowsLatest fail:', err);
      })
      .readRowsLatest(1000);
  }

  function renderTable(rowsIn){
    const rows = [...(rowsIn||[])].sort((a,b)=>{
      const k = sortState.key, dir = sortState.dir === 'asc' ? 1 : -1;
      let va = a[k], vb = b[k];
      if (k === 'amount') { va = Number(va||0); vb = Number(vb||0); }
      if (k === 'date' || k === 'dateStr') {
        va = new Date(a.dateStr || a.date); vb = new Date(b.dateStr || b.date);
      }
      if (va < vb) return -1 * dir;
      if (va > vb) return  1 * dir;
      return 0;
    });
    tblBody.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.dateStr || '')}</td>
        <td>${escapeHtml(r.title || '')}</td>
        <td>${escapeHtml(r.category || '')}</td>
        <td class="t-right">${(Number(r.amount||0)).toLocaleString()}</td>
        <td>${escapeHtml(r.type || '')}</td>
        <td>${escapeHtml(r.payer || '')}</td>
      </tr>
    `).join('');
  }
  $$('#tbl thead th').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.k; if (!k) return;
      if (sortState.key === k) sortState.dir = (sortState.dir === 'asc' ? 'desc' : 'asc');
      else { sortState.key = k; sortState.dir = 'asc'; }
      renderTable(filteredRows);
      decorateTypePills();
    });
  });

  function drawChartsFromRows(rows){
    // å·¦åœ–ï¼šåˆ†é¡é•·æ¢ï¼ˆå«æ•¸å€¼æ¨™ç±¤ï¼‰
    const byCat = {};
    rows.forEach(r=>{
      const c = (r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰').trim();
      if (!byCat[c]) byCat[c] = { inc:0, exp:0, tot:0 };
      const n = Number(r.amount||0) || 0;
      if (r.type === 'æ”¶å…¥') byCat[c].inc += n; else byCat[c].exp += n;
      byCat[c].tot += n;
    });
    const catSorted = Object.entries(byCat).sort((a,b)=> b[1].tot - a[1].tot);
    const L = { labels: catSorted.map(([k])=>k),
                inc:    catSorted.map(([,v])=>v.inc),
                exp:    catSorted.map(([,v])=>v.exp) };

    // å³åœ–ï¼šæ™‚é–“è»¸ã€Œç´¯ç©ã€æŠ˜ç·šï¼ˆé¡åˆ¥è»¸é¿å… adapter éœ€æ±‚ï¼‰
    const daily = new Map(); // yyyy-MM-dd -> {inc,exp}
    const toDate = r=>{
      if (r.dateStr){
        const m = String(r.dateStr).match(/^(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})$/);
        return m ? new Date(Number(m[1]), Number(m[2])-1, Number(m[3])) : new Date(r.dateStr);
      }
      return r.date ? new Date(r.date) : new Date(0);
    };
    [...rows].sort((a,b)=> toDate(a) - toDate(b)).forEach(r=>{
      const d = toDate(r); if (!(d instanceof Date) || isNaN(d)) return;
      const k = d.toISOString().slice(0,10);
      if (!daily.has(k)) daily.set(k,{inc:0,exp:0});
      const v = daily.get(k), n = Number(r.amount||0) || 0;
      if (r.type === 'æ”¶å…¥') v.inc += n; else v.exp += n;
    });
    const labelsT = Array.from(daily.keys()).sort();
    let accInc = 0, accExp = 0;
    const seriesInc = [], seriesExp = [];
    labelsT.forEach(k=>{ const v = daily.get(k); accInc += v.inc; accExp += v.exp; seriesInc.push(accInc); seriesExp.push(accExp); });

    // é‡ç•«
    if (chartFeatured) chartFeatured.destroy();
    if (chartOthers)   chartOthers.destroy();

    // æŸ±é ‚æ•¸å€¼æ¨™ç±¤
    const valueLabelPlugin = {
      id: 'valueLabel',
      afterDatasetsDraw(chart){
        const {ctx} = chart;
        ctx.save();
        ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans"';
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg') || '#111';
        chart.data.datasets.forEach((dset, di)=>{
          const meta = chart.getDatasetMeta(di);
          if (meta.type !== 'bar') return;
          meta.data.forEach((bar, i)=>{
            const val = dset.data[i]; if (val == null) return;
            const p = bar.tooltipPosition();
            ctx.textAlign = 'center'; ctx.textBaseline = 'bottom';
            ctx.fillText(Number(val).toLocaleString(), p.x, p.y - 4);
          });
        });
        ctx.restore();
      }
    };

    chartFeatured = new Chart(document.getElementById('chartFeatured').getContext('2d'), {
      type: 'bar',
      data: { labels: L.labels, datasets: [
        { label:'æ”¶å…¥', data: L.inc,  borderWidth:1 },
        { label:'æ”¯å‡º', data: L.exp,  borderWidth:1 }
      ]},
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ position:'top' } } },
      plugins: [valueLabelPlugin]
    });

    const typesNow = new Set(Array.from(document.querySelectorAll('#segType .segbtn.active')).map(b=>b.dataset.type));
    const datasetsT = [];
    if (typesNow.has('æ”¶å…¥')) datasetsT.push({ label:'æ”¶å…¥(ç´¯ç©)', data: seriesInc, borderWidth:2, type:'line' });
    if (typesNow.has('æ”¯å‡º')) datasetsT.push({ label:'æ”¯å‡º(ç´¯ç©)', data: seriesExp, borderWidth:2, type:'line' });

    chartOthers = new Chart(document.getElementById('chartOthers').getContext('2d'), {
      type: 'line',
      data: { labels: labelsT, datasets: datasetsT },
      options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true }, x:{ type:'category' } }, plugins:{ legend:{ position:'top' } } }
    });
  }

  function refreshCharts(){ drawChartsFromRows(filteredRows.length ? filteredRows : currentRows); }

  function applyFilters(){
    const getAct = sel => Array.from(sel.querySelectorAll('.active')).map(b=> b.dataset.val || b.dataset.type);
    const cats   = new Set(getAct(chipsCat));
    const pays   = new Set(getAct(chipsPayer));
    const types  = new Set(getAct(segType));
    const from = fltFrom.value ? new Date(fltFrom.value + 'T00:00:00') : null;
    const to   = fltTo.value   ? new Date(fltTo.value   + 'T23:59:59') : null;

    filteredRows = currentRows.filter(r=>{
      const d = r.dateStr ? new Date(r.dateStr.replace(/\./g,'/')) : (r.date ? new Date(r.date) : null);
      if (from && d && d < from) return false;
      if (to   && d && d > to)   return false;
      const c = r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰';
      const p = r.payer    || 'ï¼ˆæœªå¡«ï¼‰';
      const t = r.type     || '';
      if (cats.size  && !cats.has(c))  return false;
      if (pays.size  && !pays.has(p))  return false;
      if (types.size && !types.has(t)) return false;
      return true;
    });

    rowCount.textContent = String(filteredRows.length);
    renderTable(filteredRows);
    decorateTypePills();
    refreshCharts();

    renderSumBar();
  }

  // ===== åœ–è¡¨æ”¶åˆ/å±•é–‹ =====
  const chartsBox   = document.getElementById('chartsBox');
  const chartPh     = document.getElementById('chartPlaceholder');
  const btnChartTgl = document.getElementById('btnChartToggle');

  function setChartsCollapsed(on){
    chartsBox.classList.toggle('collapsed', !!on);
    btnChartTgl.textContent = on ? 'å±•é–‹åœ–è¡¨' : 'æ”¶åˆåœ–è¡¨';
    setTimeout(()=>{ chartFeatured?.resize(); chartOthers?.resize(); }, 0);
  }
  btnChartTgl?.addEventListener('click', ()=>{
    const on = !chartsBox.classList.contains('collapsed');
    setChartsCollapsed(on);
  });
  chartPh?.addEventListener('click', ()=> setChartsCollapsed(false));

  // ===== è·¯ç”± + åˆ†é åç¨±ï¼ˆå‹•æ…‹åµæ¸¬æ‰€æœ‰ form_ é–‹é ­çš„å®¹å™¨ï¼‰ =====
  const pageNameEl = document.getElementById('formInfo');
  function getAllPages(){
    // æ”¯æ´ä¸‰å€‹ä¸»é  + é¡å¤–é ï¼ˆlinks/code/form_codeï¼‰
    return Array.from(document.querySelectorAll('[id^="form_"], #links, #code, #form_code'))
      .map(sec => sec.id);
  }
  function currentPageFromHash(){
    var raw = (location.hash || '#form_info').replace('#','');
    var h = normalizeRoute(raw);
    var all = getAllPages();
    return all.indexOf(h) >= 0 ? h : (all.indexOf('form_info')>=0 ? 'form_info' : all[0] || 'form_info');
  }
  const pageBooted = Object.create(null);
  function showPage(name){
    var all = getAllPages();
    // å…ˆéš±è—æ‰€æœ‰é ï¼ˆform_* èˆ‡ links/codeï¼‰
    document.querySelectorAll('[id^="form_"], #links, #code, #form_code').forEach(function(sec){
      if (sec.id === name){ sec.removeAttribute('hidden'); }
      else{ sec.setAttribute('hidden',''); }
    });
    // é«˜äº® tabï¼ˆdata-nav ç¾åœ¨ç­‰æ–¼å®Œæ•´ IDï¼‰
    document.querySelectorAll('.tabbar .tab-item').forEach(function(el){
      el.classList.toggle('active', normalizeRoute(el.dataset.nav||'') === name);
    });
    // æ¨™é¡Œ
    if (pageNameEl){
      var map = { form_info:'è³‡è¨Š', form_input:'è¨˜å¸³', form_data:'åˆ†æ', links:'é€£çµ', code:'ç¨‹å¼', form_code:'ç¨‹å¼' };
      pageNameEl.textContent = map[name] || name;
    }
    // å·¦å´æŠ½å±œ aria
    var drawer = document.getElementById('fltDrawer');
    if (drawer){ drawer.setAttribute('aria-hidden', name==='form_data' ? 'false' : 'true'); }

    // é¦–æ¬¡é€²å…¥å„é çš„åˆå§‹åŒ–ï¼ˆåªè·‘ä¸€æ¬¡ï¼‰
    if (!pageBooted[name]){
      pageBooted[name] = true;
      if (name === 'form_info'){ try{ loadInfo(); }catch(e){} }
      if (name === 'form_data'){ try{ loadRows(); }catch(e){} }
      if (name === 'code' || name === 'form_code' || name === 'links'){ try{ initCodePage(); }catch(e){} }
    }

    // åˆ‡é å¾ŒçŸ­å»¶é²èª¿æ•´åœ–è¡¨å°ºå¯¸ï¼Œé¿å…åˆæ¬¡å¯¬åº¦è®€éŒ¯
    setTimeout(function(){ if (typeof window.refreshChartsOnce === 'function') window.refreshChartsOnce(); }, 0);
  }
  window.addEventListener('hashchange', function(){ showPage(currentPageFromHash()); });

  (function boot(){
    try{
      // ç•¶æ‰€æœ‰é å®¹å™¨éƒ½é‚„æ²’å‡ºç¾åœ¨ DOM æ™‚ï¼Œå»¶é²é‡è©¦
      if (!document.querySelector('[id^="form_"], #links, #code, #form_code')){
        return setTimeout(boot, 30);
      }
      showPage(currentPageFromHash());
    }catch(e){
      console.error('[router boot error]', e);
      setTimeout(boot, 60);
    }
  })();

/* === åˆ†æé ï¼šåŠ ç¸½åˆ— ===
   - é¡¯ç¤ºç›®å‰ã€Œé¡åˆ¥ã€çš„é¸å–ï¼ˆ= å·¦æŠ½å±œ chips çš„ activeï¼‰
   - å³å´é¡¯ç¤ºé‡‘é¡åˆè¨ˆï¼ˆåœ¨ filteredRows åŸºç¤ä¸Šå†ä¾é¡åˆ¥èšåˆï¼‰
   - é»æ°£æ³¡ â†’ å–æ¶ˆè©²é¡åˆ¥ï¼ˆç­‰åŒå–æ¶ˆå·¦æŠ½å±œ chipï¼‰ä¸¦é‡ç®—
*/
function renderSumBar(){
  const sumTagsBox = document.getElementById('sumTags');
  const sumRight   = document.querySelector('#sumBar .sum-right');
  const sumTotalEl = document.getElementById('sumTotal');
  if (!sumTagsBox || !sumRight || !sumTotalEl) return;

  // ç›®å‰ã€Œæœ‰è¢«é¸ä¸­ã€çš„é¡åˆ¥ï¼ˆ= å·¦å´ chips.activeï¼‰
  const activeCats = Array.from(document.querySelectorAll('#chipsCat .chip.active'))
    .map(b => b.dataset.val);
  const usingAll = activeCats.length === 0;

  // å·¦å´ï¼šå·²é¸é¡åˆ¥æ°£æ³¡
  sumTagsBox.innerHTML = '';
  if (usingAll){
    const tag = document.createElement('span');
    tag.className = 'sum-tag is-all';
    tag.textContent = 'å…¨éƒ¨é¡åˆ¥';
    sumTagsBox.appendChild(tag);
  } else {
    activeCats.forEach(cat=>{
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'sum-tag';
      btn.innerHTML = `<span>${cat}</span><span class="x">Ã—</span>`;
      btn.addEventListener('click', ()=>{
        const chip = Array.from(document.querySelectorAll('#chipsCat .chip'))
          .find(c => c.dataset.val === cat);
        if (chip){ chip.classList.remove('active'); }
        applyFilters();
      });
      sumTagsBox.appendChild(btn);
    });
  }

  // å³å´ï¼šæ”¹ç‚ºã€Œé …ç›®åŠ ç¸½ï¼š<sum> ï½œ ç›®å‰é¤˜é¡ï¼š<balance>ã€
  // å…ˆç®— sumï¼ˆä»¥ filteredRows + activeCats ç‚ºæº–ï¼‰
  let total = 0;
  const allowSet = usingAll ? null : new Set(activeCats);
  filteredRows.forEach(r=>{
    const cat = (r.category || 'ï¼ˆæœªåˆ†é¡ï¼‰').trim();
    if (allowSet && !allowSet.has(cat)) return;
    total += Number(r.amount||0);
  });

  const fN = n => Number(n||0).toLocaleString();
  // ç¢ºä¿ sum-right çµæ§‹å«å…©å€‹æ•¸å€¼å€å¡Š
  sumRight.innerHTML = '';

  const leftBlock = document.createElement('span');
  leftBlock.className = 'sum-right-block';
  leftBlock.textContent = 'é …ç›®åŠ ç¸½ï¼š';
  const sumVal = document.createElement('strong');
  sumVal.id = 'sumTotal';
  sumVal.textContent = fN(total);
  leftBlock.appendChild(sumVal);

  const sep = document.createElement('span');
  sep.className = 'sum-sep';
  sep.textContent = ' ï½œ ';

  const rightBlock = document.createElement('span');
  rightBlock.className = 'sum-right-block';
  const label2 = document.createElement('span');
  label2.textContent = 'ç›®å‰é¤˜é¡ï¼š';
  const bal = document.createElement('strong');
  bal.id = 'sumBalanceAll';
  bal.textContent = fN(CURRENT_BALANCE_ALL);
  rightBlock.appendChild(label2);
  rightBlock.appendChild(bal);

  sumRight.appendChild(leftBlock);
  sumRight.appendChild(sep);
  sumRight.appendChild(rightBlock);
}
  
  // æœ€å¾Œå†ç¶ä¸€æ¬¡ä»¥é˜²æ­¢å…¶ä»– handler é˜»æ“‹ï¼ˆæ•ç²éšæ®µï¼‰
  (function(){
    var b=document.getElementById('tabMenu'), s=document.getElementById('menuSheet');
    if (b && s){
      var toggle=function(ev){ ev.preventDefault(); ev.stopPropagation(); s.classList.toggle('open'); s.setAttribute('aria-hidden', s.classList.contains('open') ? 'false' : 'true'); };
      b.addEventListener('click', toggle, true);
      document.addEventListener('click', function(ev){ if (ev.target && ev.target.closest && ev.target.closest('#tabMenu')) toggle(ev); }, true);
    }
  })();

})();
</script>